<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myCareerMax | Job Search</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <style>
        hr {
            border: none;
            height: 1px;
            /* sets the thickness of the line */
            background-color: #dddddd;
            /* sets the color of the line */
            margin-top: 20px;
            /* adds space above the line */
            margin-bottom: 20px;
            /* adds space below the line */
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }

        label,
        input,
        button {
            margin-bottom: 5px;
        }

        #jobs-list {
            width: 100%;
            background-image: url('/static/images/jobs_list_bg.svg');
            border-radius: 15px;
            border: 1px solid #ccc;

            /* background-color: #7300ff;*/
            height: calc(100vh - 150px);
            overflow-y: auto;
            padding: 20px;
            /* This adds padding inside the container around the job boxes */
        }

        .job h2 {
            margin-top: 0;
        }

        .job a {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
            margin-top: 10px;
        }

        .job-title {
            padding: 15px 10px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
        }

        .job-title:hover {
            background-color: #f5f5f5;
        }

        #search-container {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background-image: url('/static/images/search_container_bg.svg'), radial-gradient(circle, #b700ff, #3776ff);
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 10px;
            min-height: 80px;
            height: auto;
        }

        #search-container input[type="text"] {
            margin: 0 10px 10px 0;
            border-radius: 15px;
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
        }

        #search-container input[type="text"]::placeholder {
            text-align: center;
            font-size: 12px;
        }

        @media screen and (max-width: 767px) {
            #search-container {
                flex-direction: column;
                align-items: stretch;
                max-height: 100px;
                /* Example height, adjust as needed */
                overflow-y: auto;
                /* Enables vertical scrolling */
            }

            #search-container input[type="text"],
            #search-container button,
            #search-container label {
                width: calc(100% - 20px);
                margin: 5px 10px;
                box-sizing: border-box;
            }
        }


        #search-button {
            padding: 3px 20px;
            background-image: radial-gradient(circle, #b700ff, #3776ff);
            color: white;
            font-size: 14px;
            border-radius: 15px;
            margin-left: 5px;
            background-image: linear-gradient(to right, blue, purple);
            /* Gradient background */
            color: white;
            /* White text */
            border: 20x;
            border-color: white;
            border-radius: 10px;
            /* Rounded corners */
            box-shadow: 2px 4px 8px rgba(255, 255, 255, 0.9);
            cursor: pointer;
        }

        #main-content {
            padding-top: 150px;
            width: 100%;
            background-image: url('/static/images/jobs_list_bg.svg');
            /* background-image: linear-gradient(120deg, #b700ff, #3776ff); */
            /* Change this to your desired background color */
            display: flex;
            justify-content: center;
            /* This will center the child elements */
        }

        @media screen and (min-width: 768px) {
            #main-content {
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
                padding-top: 150px;
            }

            #jobs-list {
                width: 40%;
                border-right: 1px solid #ccc;
                height: calc(100vh - 150px);
                overflow-y: auto;
            }

            #selected-job-details {
                width: 60%;
                border: 1px solid #ccc;
                margin-bottom: 20px;
                margin-top: 20px;
                margin-left: 20px;
                margin-right: 20px;
                background-image: url('/static/images/job_details_bg (1).svg');
                border-radius: 5px;
                background-color: white;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                height: calc(100vh - 150px);
                /* Match height of job listings */
                overflow-y: auto;
                /* Scrollbar appears if content overflows */
                padding: 20px;
            }

            .close-button {
                display: block;
            }
        }

        @media screen and (max-width: 767px) {

            #jobs-list {
                height: calc(100vh - 56px);
                overflow-y: auto;
            }

            #selected-job-details {
                display: none;
                position: fixed;
                top: 56px;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                z-index: 100;
                background-color: rgba(255, 255, 255, 0.9);
                max-height: calc(100vh - 150px);
                overflow-y: auto;
                padding: 20px;
                max-height: calc(100vh - 56px);
            }
        }

        .close-button {
            display: block;
            position: fixed;
            top: 65px;
            right: 15px;
            background: transparent;
            color: red;
            cursor: pointer;
            z-index: 101;
        }


        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
        }



        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .job-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }



        .job-header-bottom {
            flex-basis: 100%;
            margin-top: 10px;
        }

        .logo-container {
            display: flex;
            justify-content: start;
            align-items: center;
        }

        .logo-date-container {
            display: flex;
            justify-content: start;
            align-items: center;
            flex-grow: 1;
        }

        .posted-at {
            padding: 5px;
            border-radius: 5px;
            background-color: #f8f8f8;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .save-icon {
            margin-left: auto;
            margin-right: 10px;
            cursor: pointer;
            padding: 8px;
        }

        .employer-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .job-title {
            width: 100%;
            text-align: left;
            font-size: 1.25em;
            font-weight: bold;
            margin: 0;
            padding: 0;
        }

        .sub-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-size: 0.875em;
        }

        .employer-and-city-container {
            display: flex;
            align-items: center;
        }

        .employer-name,
        .job-city {
            margin-right: 0;
        }

        .salary-remote-type-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: start;
            align-items: center;
            margin-top: 10px;
        }

        .salary-range,
        .job-type-remote,
        .employment-type,
        .job-benefit-tag {
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 10px;
            margin-right: 10px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            display: inline-block;
        }

        .job.selected {
            border: 5px solid #66ff00;
        }

        .job {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            /* This adds space between job boxes */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: white;
            /* This sets the job box background color */
            cursor: pointer;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        /* Ensure the publisher container has no padding or margin to start with */
        .publisher-name {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            /* Adjust the spacing as needed */
        }

        .gradient-button {
            background-image: linear-gradient(to right, #b700ff, #3776ff);
            color: white;
            /* You can change text color if needed */
            border: none;
            border-radius: 10px;
            /* Rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* Box shadow */
            /* Add any additional styling as needed */
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid blue;
            /* Spinner color */
            border-radius: 50%;
            width: 40px;
            /* Spinner size */
            z-index: 2000;
            /* Example: High value to ensure it's on top */

            height: 40px;
            position: fixed;
            /* Fixed position */
            top: 50%;
            /* Center the spinner */
            left: 50%;
            transform: translate(-50%, -50%);
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        hr {
            border: none;
            height: 1px;
            background-color: #000000;
            margin-top: 10px;
            margin-bottom: 10px;
            margin-left: 10px;
            margin-right: 10px;
            width: 100%;
        }

        .material-symbols-outlined.icon-shadow:hover {
            cursor: pointer;
        }

        #search-container input[type="text"] {
            margin: 0 10px 10px 0;
            border-radius: 15px;
            border: 1px solid #ccc;
            padding: 3px 5px;
            /* Reduced padding */
            text-align: center;
            font-size: 12px;
            /* Adjust font size as needed */
        }


        @media screen and (max-width: 767px) {
            #search-container {
                display: flex;
                flex-direction: row;
                /* Align items horizontally */
                flex-wrap: wrap;
                justify-content: flex-start;
                align-items: flex-start;
                padding: 1px;
                /* Adjust padding */
            }

            #search-container .search-fields {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                max-width: 150px;
                margin-right: 10px;
                /* Space to the right of search fields */
            }

            #search-container .search-controls {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                max-width: 150px;
                margin-left: 10px;
                /* Space to the left of search controls */
            }

            #search-container #job-query,
            #search-container #job-location {
                width: 100%;
                margin: 1px 0;
                /* Adjust margin */
            }

            #search-container #search-button,
            #search-container #filters-container {
                width: 100%;
                margin: 1px 0;
                margin-top: 10px;
            }

            #search-container #filters-container {
                display: flex;
                justify-content: flex-start;
                align-items: center;
            }

            #search-container #filters-container label {
                margin-left: 5px;

            }
        }

        #search-container #filters-container label,
        #search-container #filters-container input[type="checkbox"] {
            font-size: 12px;
            /* Smaller font size for smaller screens */
            color: white;
            /* Ensuring the text is white */
            /* Make text and checkbox white */
        }

        #search-container #job-query,
        #search-container #job-location {
            border: 2px solid #39FF14;
            /* Neon green border */
        }
    </style>

</head>

<body>

    <input type="hidden" id="userId" value="{{ user_id }}">

    <script>
        // Define the deleteDocument function in the global scope
        function deleteDocument(documentId) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }

            $.ajax({
                url: `/delete_document/${documentId}`,
                type: 'DELETE',
                success: function (result) {
                    // Remove the document row from the table
                    $(`#doc-row-${documentId}`).remove();
                },
                error: function (error) {
                    alert('Error: ' + error.responseText);
                }
            });
        };
        $(document).ready(function () {
            console.log("User ID:", $("#userId").val()); // Using jQuery to log the user ID
            console.log("Fetching username...");
            $.get("/get-username", function (response) {
                console.log("Username response:", response);
                if (response.success) {
                    const usernamePlaceholder = document.getElementById("username-placeholder");
                    usernamePlaceholder.textContent = "Hello, " + response.username;
                } else {
                    console.error('Error fetching username:', response.error);
                }
            });
        });
    </script>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="https://www.mycareermax.com" style="color: #003c86;">myCareerMax.com</a>
        <button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
            data-target="#navbarNav" data-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <!-- Existing dropdown for the username -->
                <li class="nav-item dropdown">
                    <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                        data-toggle="dropdown" href="#" id="navbarDropdown" role="button" style="color: #003c86;">
                        <span id="username-placeholder">Login Here</span>
                    </a>
                    <div aria-labelledby="navbarDropdown" class="dropdown-menu">
                        <a class="dropdown-item" href="/dashboard#my-docs" style="color: #003c86;">My AI Docs</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/login" style="color: #00b018;">Login</a>
                        <a class="dropdown-item" href="/logout" style="color: #0d00ff;">Logout</a>
                        <a class="dropdown-item" href="/delete_account" style="color: #ff0000;">Delete Account</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard" style="color: #003c86;">myDashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/search" style="color: #003c86;">AI Job Search</a>
                </li>
                <!-- Tools Dropdown -->
                <li class="nav-item dropdown">
                    <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                        data-toggle="dropdown" href="#" id="toolsDropdown" role="button" style="color: #003c86;">
                        Tools
                    </a>
                    <div aria-labelledby="toolsDropdown" class="dropdown-menu">
                        <a class="dropdown-item" href="/resume-enhancer" style="color: #003c86;">Resume Scanner</a>
                        <a class="dropdown-item" href="/interview-prep" style="color: #003c86;">Interview Prep</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/create" style="color: #003c86;">Createâœ¨</a>
                </li>
                <!-- New link for CareerBot -->
                <li class="nav-item">
                    <a class="nav-link" href="/careerbot" style="color: #003c86;">Max</a>
                </li>
                <!-- End of Dropdown for username -->
            </ul>
        </div>
    </nav>
    <div id="search-container">
        <div class="search-fields">
            <label for="job-query"></label>
            <input type="text" id="job-query" placeholder="Job title or Keyword(s)">
            <label for="job-location"></label>
            <input type="text" id="job-location" placeholder="Location">
        </div>
        <div class="search-controls">
            <button id="search-button">Search</button>
            <div id="filters-container">
                <!-- <select id="category-select">
                <option value="">Select Category</option>
            </select>
            <select id="job-title-select">
                <option value="">Select Job Title</option>
            </select>
           Add more dropdowns or checkboxes for other filters -->

                <!-- Checkbox for Remote Jobs Only -->
                <label>
                    <input type="checkbox" id="remote-jobs-only" />
                    Remote Jobs Only
                </label>
            </div>
        </div>



    </div>
    <div class="spinner" style="display: none;"></div>

    <div id="main-content">
        <div id="jobs-list">
            <!-- Job listings will be dynamically inserted here -->
        </div>
        <div id="selected-job-details">
            <!-- Job details will be dynamically inserted here including the close button -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const searchButton = document.getElementById('search-button');
            const jobsList = document.getElementById('jobs-list');
            const selectedJobDetails = document.getElementById('selected-job-details');
            let page = 1;
            let isFetchingJobs = false;

            function updateAllSaveIcons() {
                const savedJobs = JSON.parse(localStorage.getItem('savedJobs') || '{}');

                document.querySelectorAll('.job').forEach(jobCard => {
                    const jobId = jobCard.getAttribute('data-job-id');
                    const saveIcon = jobCard.querySelector('.save-icon');

                    if (savedJobs[jobId]) {
                        saveIcon.textContent = 'bookmark_added'; // Icon indicating the job is saved
                    } else {
                        saveIcon.textContent = 'bookmark'; // Icon indicating the job is not saved
                    }
                });
            }


            async function generateDocumentsAndResume(jobId, jobTitle, jobDescription, companyName, applyLink, jobTitleElement) {
                const userId = getUserIdFromSession();
                if (!userId) {
                    console.error('User ID is not available');
                    document.querySelector('.spinner').style.display = 'none';
                    alert('You must be logged in to generate documents.');
                    return;
                }

                const postData = {
                    jobId: jobId,
                    job_title: jobTitle,
                    employer_name: companyName,
                    job_description: jobDescription,
                    apply_link: applyLink
                };

                try {
                    // Generate Cover Letter
                    const coverLetterResponse = await fetch('/job-details-coverletter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData)
                    });

                    const coverLetterData = await coverLetterResponse.json();
                    if (coverLetterData.message === "Cover letter generated and saved successfully") {
                        console.log('Cover letter generated:', coverLetterData);
                        // Additional logic to display cover letter response
                        if (jobTitleElement) {
                            jobTitleElement.click();
                        }
                    } else {
                        console.error('Failed to generate cover letter:', coverLetterData);
                    }

                    // Generate Resume
                    const resumeResponse = await fetch('/job-details-resume', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData)
                    });

                    const resumeData = await resumeResponse.json();
                    if (resumeData.message === "Resume generated and saved successfully") {
                        console.log('Resume generated:', resumeData);
                        // Additional logic to display resume response
                        if (jobTitleElement) {
                            jobTitleElement.click();
                        }
                    } else {
                        console.error('Failed to generate resume:', resumeData);
                    }

                    localStorage.setItem(`documentGenerated_${jobId}`, 'true');
                    console.log('Document generation status stored in local storage for job ID:', jobId);

                } catch (error) {
                    console.error('Error generating documents:', error);
                    alert('An error occurred while generating documents. Please check the console for more details.');
                } finally {
                    document.querySelector('.spinner').style.display = 'none';
                }
            }


            function getUserIdFromSession() {
                const userIdElement = document.getElementById('userId');
                if (!userIdElement) {
                    console.error('User ID element not found');
                    return null;
                }
                const userId = userIdElement.value;
                console.log('Current user ID: ', userId);
                return userId;
            }

            function toggleCloseButton(show) {
                const closeButton = document.querySelector('.close-button');
                if (window.innerWidth < 768) {
                    if (show) {
                        if (closeButton) closeButton.style.display = 'block';
                        jobsList.style.display = 'none';
                        document.getElementById('search-container').style.display = 'none';
                    } else {
                        if (closeButton) closeButton.style.display = 'none';
                        jobsList.style.display = 'block';
                        document.getElementById('search-container').style.display = 'flex';
                    }
                }
            }

            function bindCloseButton() {
                const closeButton = document.querySelector('.close-button');
                if (closeButton) {
                    closeButton.addEventListener('click', function () {
                        selectedJobDetails.style.display = 'none';
                        toggleCloseButton(false);
                    });
                }
            }

            function checkScreenSize() {
                if (window.innerWidth < 768) {
                    if (selectedJobDetails.style.display === 'none' || selectedJobDetails.style.display === '') {
                        document.getElementById('search-container').style.display = 'flex';
                        jobsList.style.display = 'block';
                    }
                } else {
                    document.getElementById('search-container').style.display = 'flex';
                    jobsList.style.display = 'block';
                }
                toggleCloseButton(selectedJobDetails.style.display === 'block');
            }
            // Function to fetch job listings based on the current search criteria
            function fetchJobListings() {
                console.log('Fetching initial job listings');
                const jobQuery = document.getElementById('job-query').value;
                const jobLocation = document.getElementById('job-location').value;
                const remoteJobsOnly = document.getElementById('remote-jobs-only').checked;

                const queryParams = new URLSearchParams({
                    query: jobQuery,
                    location: jobLocation,
                    page: page,
                    remote_jobs_only: remoteJobsOnly
                });

                fetch(`/fetch-job-listings-get?${queryParams.toString()}`, { method: 'GET' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response Data:', data);
                        displayJobListings(data.data || [], false);
                        isFetchingJobs = false;
                        if (window.innerWidth > 767) {
                            selectFirstJob();
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching job listings:', error);
                        isFetchingJobs = false;
                    });
            }

            // Function to reset and fetch job listings
            function resetAndFetchJobListings() {
                page = 1; // Reset the page counter
                jobsList.innerHTML = ''; // Clear the job list
                fetchJobListings(); // Fetch the job listings
            }

            // Add an event listener to the checkbox
            document.getElementById('remote-jobs-only').addEventListener('change', resetAndFetchJobListings);

            // Event listener for the search button
            if (searchButton) {
                searchButton.addEventListener('click', resetAndFetchJobListings);
            }

            function fetchMoreJobListings() {
                if (isFetchingJobs) return; // Prevent multiple simultaneous requests
                isFetchingJobs = true; // Set flag to true
                page++; // Increment page number for the next API call

                // Make an API call similar to fetchJobListings but for the next page
                const jobQuery = document.getElementById('job-query').value;
                const jobLocation = document.getElementById('job-location').value;
                const remoteJobsOnly = document.getElementById('remote-jobs-only').checked;

                const queryParams = new URLSearchParams({
                    query: jobQuery,
                    location: jobLocation,
                    page: page,
                    remote_jobs_only: remoteJobsOnly
                });

                fetch(`/fetch-job-listings-get?${queryParams.toString()}`, { method: 'GET' })
                    .then(response => response.json())
                    .then(data => {
                        displayJobListings(data.data || [], true); // Append new jobs to the existing list
                        isFetchingJobs = false; // Reset the flag after successful fetch
                    })
                    .catch(error => {
                        console.error('Error fetching more job listings:', error);
                        isFetchingJobs = false; // Reset the flag even if the fetch fails
                    });
            }


            // Function to select the first job in the list
            function selectFirstJob() {
                const firstJobTitle = document.querySelector('.job-title');
                if (firstJobTitle) {
                    firstJobTitle.click();
                }
            }

            // Function to fetch and display search filters
            function fetchAndDisplaySearchFilters() {
                fetch('/fetch-job-filters', { method: 'GET' })
                    .then(response => response.json())
                    .then(data => {
                        displayDropdownOptions('category-select', data.data.categories);
                        displayDropdownOptions('job-title-select', data.data.job_titles);
                        // Repeat for other filters as necessary
                    })
                    .catch(error => {
                        console.error('Error fetching search filters:', error);
                    });
            }

            // Function to display dropdown options
            function displayDropdownOptions(selectId, options) {
                const selectElement = document.getElementById(selectId);
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.name;
                    selectElement.appendChild(optionElement);
                });
            }

            // Initialize the filters on page load
            document.addEventListener('DOMContentLoaded', fetchAndDisplaySearchFilters);


            // Call this function once to setup the infinite scrolling
            function setupInfiniteScroll() {
                const jobsList = document.getElementById('jobs-list');
                jobsList.addEventListener('scroll', () => {
                    // Add a buffer amount to the condition to handle fast scrolling
                    if (jobsList.scrollTop + jobsList.clientHeight >= jobsList.scrollHeight - 200) {
                        fetchMoreJobListings();
                    }
                });
            }

            // Call this function once to setup the infinite scrolling
            setupInfiniteScroll();

            // Function to format job type
            function formatJobType(jobType) {
                const jobTypeMap = {
                    'FULLTIME': 'Full-time',
                    'INTERN': 'Intern',
                    'PERDIEM': 'Per diem',
                    'CONTRACTOR': 'Contractor',
                    'PARTTIME': 'Part-time',
                    'TEMPORARY': 'Temp'
                };
                // Return the mapped value or the original if not found in the map
                return jobTypeMap[jobType] || jobType;
            }

            // Function to map benefit keys to user-friendly text
            function mapBenefitToDisplayText(benefit) {
                const benefitDisplayMap = {
                    'paid_time_off': 'PTO',
                    'health_insurance': 'Health',
                    'retirement_savings': 'Retirement',
                    'dental_coverage': 'Dental',
                    'Part-time Benefit Eligible': 'PT Benefit Eligible',
                };

                // Return the display text if found, or default to the benefit as-is
                return benefitDisplayMap[benefit] || benefit.replace(/_/g, ' ');
            }

            // Function to format the date and time
            function formatDateTime(dateTimeString) {
                // Create a Date object from the dateTimeString
                const date = new Date(dateTimeString);
                // Format the date and time in a readable format
                return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            }

            // Function to remove 'selected' class from all job cards
            function clearSelectedJobCards() {
                document.querySelectorAll('.job.selected').forEach(function (jobCard) {
                    jobCard.classList.remove('selected');
                });
            }

            function displayJobListings(jobs, append = false) {
                console.log(`Displaying ${jobs.length} job listings, Append: ${append}`);
                let oldScrollPosition = jobsList.scrollTop;
                if (!append) {
                    jobsList.innerHTML = '';
                    selectedJobDetails.innerHTML = '';
                }

                const savedJobs = JSON.parse(localStorage.getItem('savedJobs') || '{}');

                jobs.forEach(job => {
                    console.log(`Processing job: ${job.job_title}, Documents Generated: ${job.documents_generated}`);
                    const jobCard = document.createElement('div');
                    jobCard.className = 'job';

                    // Create a container div for the logo and the date
                    const jobHeaderTop = document.createElement('div');
                    jobHeaderTop.className = 'job-header-top';

                    // Create logo container and logo image
                    const logoContainer = document.createElement('div');
                    logoContainer.className = 'logo-container';
                    const logoImg = document.createElement('img');
                    logoImg.src = job.employer_logo || '/static/images/default_logo.png';
                    logoImg.alt = job.employer_name + ' logo';
                    logoImg.className = 'employer-logo';
                    logoImg.onerror = function () {
                        this.src = '/static/images/default_logo.png';
                    };
                    logoContainer.appendChild(logoImg);

                    // Date text
                    const postedAtDiv = document.createElement('div');
                    postedAtDiv.className = 'posted-at';
                    postedAtDiv.innerText = formatDateTime(job.job_posted_at_datetime_utc);

                    jobCard.setAttribute('data-job-id', job.job_id);

                    // Save icon
                    const saveIcon = document.createElement('span');
                    saveIcon.className = 'material-symbols-outlined save-icon';
                    saveIcon.textContent = 'bookmark';

                    // This function is called when the save icon is clicked.
                    saveIcon.onclick = function (event) {
                        event.preventDefault();
                        const jobCard = event.target.closest('.job');
                        const jobId = jobCard.getAttribute('data-job-id');

                        const savedJobs = JSON.parse(localStorage.getItem('savedJobs') || '{}');
                        const isCurrentlySaved = !!savedJobs[jobId];

                        // Prepare job data for backend
                        const jobData = {
                            job_id: job.job_id,
                            job_title: job.job_title,
                            job_description: job.job_description,
                            job_link: job.job_apply_link,
                            job_loc: job.job_city,
                            company_name: job.employer_name,
                            link: window.location.href,
                            employer_logo: job.employer_logo
                        };

                        // Determine the appropriate endpoint based on current saved status
                        const endpoint = isCurrentlySaved ? '/remove-saved-job' : '/save-job';

                        fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(jobData)
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Toggle saved status in local storage
                                    if (isCurrentlySaved) {
                                        delete savedJobs[jobId];
                                    } else {
                                        savedJobs[jobId] = true;
                                    }
                                    localStorage.setItem('savedJobs', JSON.stringify(savedJobs));

                                    // Update UI to reflect new saved status
                                    updateSaveIconUI(saveIcon, !isCurrentlySaved);
                                } else {
                                    console.error('Failed to update job save status:', data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error updating job save status:', error);
                            });
                    };

                    function updateSaveIconUI(iconElement, isSaved) {
                        iconElement.textContent = isSaved ? 'bookmark_added' : 'bookmark'; // Update with appropriate icons
                    }

                    // Append the logo container and date to the jobHeaderTop
                    jobHeaderTop.appendChild(logoContainer);
                    jobHeaderTop.appendChild(postedAtDiv);

                    // Append the save icon to the jobHeaderTop
                    jobHeaderTop.appendChild(saveIcon);


                    // Create a new div for the job title, which will be below the logo and date
                    const jobHeaderBottom = document.createElement('div');
                    jobHeaderBottom.className = 'job-header-bottom';

                    // Job title
                    const jobTitle = document.createElement('div');
                    jobTitle.className = 'job-title';
                    jobTitle.innerText = job.job_title || 'No title provided';
                    jobHeaderBottom.appendChild(jobTitle);

                    // Append the job header top and bottom to the job card
                    jobCard.appendChild(jobHeaderTop);
                    jobCard.appendChild(jobHeaderBottom);

                    // Create a sub-container for employer name and job city
                    const subHeader = document.createElement('div');
                    subHeader.className = 'sub-header';

                    // Create a div for the employer name and add it to the sub-header
                    const employerNameDiv = document.createElement('div');
                    employerNameDiv.className = 'employer-name';
                    employerNameDiv.innerText = job.employer_name;
                    subHeader.appendChild(employerNameDiv);

                    // Add the job city if it is specified and not "Not specified"
                    if (job.job_city && job.job_city !== "Not specified") {
                        employerNameDiv.innerText += ', ' + job.job_city; // Append city to employer name
                    }

                    // Create a div for the employment type but do not append yet
                    const employmentTypeDiv = document.createElement('div');
                    employmentTypeDiv.className = 'employment-type';
                    employmentTypeDiv.innerText = formatJobType(job.job_employment_type) || 'Not specified';

                    // Append the sub-header to the job card
                    jobCard.appendChild(subHeader);

                    // Publisher name
                    const publisherDiv = document.createElement('div');
                    publisherDiv.className = 'publisher-name';
                    publisherDiv.innerText = `via ${job.job_publisher || 'Not specified'}`;
                    jobCard.appendChild(publisherDiv);

                    // Create a container for the salary, remote information, employment type, and benefits
                    const salaryRemoteTypeContainer = document.createElement('div');
                    salaryRemoteTypeContainer.className = 'salary-remote-type-info';

                    // Function to format salary
                    function formatSalary(salary) {
                        if (salary >= 1000) {
                            return `$${(salary / 1000).toFixed(0)}K`;
                        } else {
                            return `$${salary}`;
                        }
                    }

                    // Add salary information if available
                    if (job.job_max_salary && job.job_min_salary) {
                        const salaryRange = document.createElement('div');
                        salaryRange.className = 'salary-range';
                        salaryRange.innerText = `${formatSalary(job.job_min_salary)} - ${formatSalary(job.job_max_salary)}`;
                        salaryRemoteTypeContainer.appendChild(salaryRange);
                    }

                    // Add remote information
                    const jobTypeRemote = document.createElement('div');
                    jobTypeRemote.className = 'job-type-remote';
                    jobTypeRemote.innerText = job.job_is_remote ? 'Work From Home' : 'In-Person';
                    salaryRemoteTypeContainer.appendChild(jobTypeRemote);

                    // Append the employment type to the right
                    salaryRemoteTypeContainer.appendChild(employmentTypeDiv);

                    // Add job benefits if available
                    if (job.job_benefits && job.job_benefits.length > 0) {
                        job.job_benefits.forEach(benefit => {
                            const benefitText = mapBenefitToDisplayText(benefit); // Get the display text for each benefit
                            const benefitTag = createBenefitTag(benefitText); // Create the benefit tag
                            salaryRemoteTypeContainer.appendChild(benefitTag); // Append the benefit tag to the container
                        });
                    }

                    // Function to create a benefit tag
                    function createBenefitTag(benefitText) {
                        const benefitDiv = document.createElement('div');
                        benefitDiv.className = 'job-benefit-tag';
                        benefitDiv.innerText = benefitText; // Set the innerText to the benefitText passed in
                        benefitDiv.style.border = '1px solid #ccc';
                        benefitDiv.style.borderRadius = '15px';
                        benefitDiv.style.padding = '10px';
                        benefitDiv.style.marginRight = '10px';
                        benefitDiv.style.backgroundColor = '#f8f8f8';
                        benefitDiv.style.display = 'inline-block';
                        return benefitDiv;
                    }

                    // Append the salary, remote, and type container to the job card
                    jobCard.appendChild(salaryRemoteTypeContainer);
                    // Add "Custom Documents Generated" indicator if applicable
                    if (localStorage.getItem(`documentGenerated_${job.job_id}`) === 'true') {
                        const customDocsContainer = document.createElement('div');
                        customDocsContainer.className = 'custom-docs-container';

                        const customDocsIndicator = document.createElement('div');
                        customDocsIndicator.className = 'custom-docs-indicator';

                        // Create a span for the icon
                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'material-symbols-outlined';
                        iconSpan.textContent = 'task';

                        // Append the icon span to the customDocsIndicator
                        customDocsIndicator.appendChild(iconSpan);

                        // Add a text node for the text
                        const textNode = document.createTextNode(' Custom Documents Generated');
                        customDocsIndicator.appendChild(textNode);

                        // Append the customDocsIndicator to the customDocsContainer
                        customDocsContainer.appendChild(customDocsIndicator);

                        // Append the customDocsContainer to the jobCard
                        jobCard.appendChild(customDocsContainer);
                        console.log(`Added Custom Documents indicator for job: ${job.job_title}`);
                    }

                    // Inside the job title click event listener
                    jobTitle.addEventListener('click', function () {
                        clearSelectedJobCards();
                        jobCard.classList.add('selected'); // Highlight the selected job card

                        // Populate the selectedJobDetails with detailed information
                        selectedJobDetails.innerHTML = `
        <span class="material-symbols-outlined close-button">close</span>
<div class="job-details">
    <h2 style="margin-top: 10px; text-align: center;"><strong>${job.job_title}</strong></h2>
    <div class="employer-and-location-container">
        <p style="margin-bottom: 1px; color: black; text-align: center;"><strong>${job.employer_name}</strong></p> 
        <p style="margin-top: 1px; color: black; text-align: center;">${job.job_city || 'Not specified'}</p>
    </div>
</div>



            <hr>
            <div id="generate-docs-button-container"></div>
            <hr>
            <div class="job-employment-salary-benefits">
                <p><strong>Employment Type:</strong> ${formatJobType(job.job_employment_type) || 'Not specified'}</p>
                <p><strong>Work Environment:</strong> ${job.job_is_remote ? 'Remote' : 'In-Person'}</p>
                <p><strong>Salary:</strong> ${job.job_salary ? `$${job.job_salary}` : 'Not specified'}</p>
                <p><strong>Benefits:</strong> ${job.job_benefits && job.job_benefits.length > 0
                                ? job.job_benefits.map(benefit => mapBenefitToDisplayText(benefit)).join(', ')
                                : 'Not specified'
                            }</p>
            </div>
            <hr>
            <p>${job.job_apply_link ? `<a href="${job.job_apply_link}" target="_blank" style="display: inline-block; padding: 5px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px;">Apply Here</a>` : 'Not provided'}</p>
            <hr>
            <div class="highlights-title-subtitle-container">
                <p style="margin-bottom: 1px; color: black; font-size: 18px;"><strong>Job highlights</strong></p>
                <p style="margin-top: 1px; color: black; font-size: 14px;">Identified from the original job post</p>
            </div>
            ${Object.entries(job.job_highlights).map(([key, value]) => `
                <strong>${key}:</strong>
                <ul>${value.map(item => `<li>${item}</li>`).join('')}</ul>
            `).join('')}
            <hr>
            <p><strong>Job Description</strong></p>
            <p class="job-description">${job.job_description}</p>
        </div>
    `;

                        // Get the generate-docs-button-container and append the Generate Docs button
                        const generateDocsButtonContainer = document.getElementById('generate-docs-button-container');
                        const generateDocsButton = document.createElement('button');
                        generateDocsButton.className = 'generate-docs-button btn btn-primary gradient-button'; // Added 'gradient-button' class
                        generateDocsButton.textContent = 'âœ¨ Generate Custom Docs';
                        generateDocsButton.dataset.jobId = job.job_id;
                        generateDocsButtonContainer.appendChild(generateDocsButton);

                        // Create a container for the documents right after the Generate Docs button
                        const documentsContainer = document.createElement('div');
                        documentsContainer.id = 'documentsContainer';
                        generateDocsButtonContainer.appendChild(documentsContainer); // Append documentsContainer here

                        // Fetch and display documents for this job
                        fetchAndDisplayJobDocuments(job.job_title, job.employer_name);

                        selectedJobDetails.style.display = 'block';
                        toggleCloseButton(true);
                        bindCloseButton();
                    });

                    function fetchAndDisplayJobDocuments(jobTitle, companyName) {
                        let userId = $("#userId").val();

                        $.get(`/get_user_documents?jobTitle=${encodeURIComponent(jobTitle)}&companyName=${encodeURIComponent(companyName)}&userId=${userId}`, function (documents) {
                            let tableHTML = '<table class="table table-bordered"><thead><tr><th>Document Type</th><th>Creation Date</th><th colspan="2">Download</th><th>Delete</th></tr></thead><tbody>';

                            documents.forEach(doc => {
                                let downloadRoute;
                                if (doc.document_type === 'Tailored Resume') {
                                    downloadRoute = '/download_html2pdf';
                                } else if (doc.document_type === 'Custom Cover Letter') {
                                    downloadRoute = '/download_document';
                                } else {
                                    // Handle other document types or set a default route
                                    downloadRoute = '/some_default_route';
                                }

                                let docxDownloadLink = '';
                                if (doc.document_type !== 'Tailored Resume') {
                                    docxDownloadLink = `
            <td>
                <a href="${downloadRoute}/${doc.id}?format=docx">
                    <img src="/static/images/docx.svg" alt="DOCX" width="24" height="24">
                </a>
            </td>
        `;
                                } else {
                                    // Add an empty cell when there is no DOCX link
                                    docxDownloadLink = '<td></td>';
                                }

                                tableHTML += `
        <tr id="doc-row-${doc.id}">
            <td>${doc.document_type}</td>
            <td>${doc.creation_date}</td>
            <td>
                <a href="${downloadRoute}/${doc.id}?format=pdf">
                    <img src="/static/images/pdf.svg" alt="PDF" width="24" height="24">
                </a>
            </td>
            ${docxDownloadLink}
            <td>
                <span class="material-symbols-outlined icon-shadow" '
                    onclick="deleteDocument(${doc.id})">
                    Delete
                </span>
            </td>
                    </tr>
    `;
                            });




                            tableHTML += '</tbody></table>';
                            const documentsContainer = document.getElementById('documentsContainer');
                            if (documentsContainer) {
                                documentsContainer.innerHTML = tableHTML;
                            }
                        });
                    }



                    jobsList.appendChild(jobCard);

                });

                if (append) {
                    setTimeout(() => { jobsList.scrollTop = oldScrollPosition; }, 0);
                }

                updateAllSaveIcons();
            }

            selectedJobDetails.addEventListener('click', function (event) {
                if (event.target.classList.contains('generate-docs-button')) {
                    // Show spinner
                    document.querySelector('.spinner').style.display = 'block';

                    // Retrieve the job title
                    const jobTitle = selectedJobDetails.querySelector('.job-details h2').textContent;

                    // Retrieve the company name (employer name)
                    const companyName = selectedJobDetails.querySelector('.employer-and-location-container strong').textContent;

                    // Retrieve the job description
                    const jobDescriptionElement = selectedJobDetails.querySelector('.job-description');
                    const jobDescription = jobDescriptionElement ? jobDescriptionElement.textContent : "";

                    // Retrieve the apply link
                    const applyLinkElement = selectedJobDetails.querySelector('.job-details a[href]');
                    const applyLink = applyLinkElement ? applyLinkElement.href : "";

                    // Retrieve the jobId from the selected job card
                    const jobCard = document.querySelector('.job.selected');
                    const jobId = jobCard.dataset.jobId;

                    // Retrieve the job title element from the selected job card
                    const jobTitleElement = jobCard ? jobCard.querySelector('.job-title') : null;

                    // Pass the jobTitleElement to the generateDocumentsAndResume function
                    generateDocumentsAndResume(jobId, jobTitle, jobDescription, companyName, applyLink, jobTitleElement);
                }
            });

            // Bind click event to save icons
            document.querySelectorAll('.save-icon').forEach(saveIcon => {
                saveIcon.addEventListener('click', function () {
                    const jobId = this.getAttribute('data-job-id');
                    const isCurrentlySaved = localStorage.getItem(`jobSaved_${jobId}`) === 'true';
                    saveJob(jobId, isCurrentlySaved);
                });
            });
            fetchJobListings();

            setupInfiniteScroll();
            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);
        });
    </script>
</body>

</html>
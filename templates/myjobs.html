<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>myJobs | myCareerMax</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Preconnect to font domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font and other styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&display=swap" rel="stylesheet">

    <style>
        .compatibility-percentage {
            font-size: 25px;
            font-weight: bold;
            color: #001aff;
        }

        /* General styling */
        body {
            background: #ffffff;
            color: #000000;
        }

        h2 {
            color: #ffffff;
            font-size: 24px;
        }

        .kanban-column-header {
            position: relative;
            z-index: 1;
            margin-bottom: 40px;
        }

        .kanban-column-header h3 {
            font-size: 46px;
            font-family: 'Caveat', cursive;
            margin-bottom: 10px;
        }

        /* Kanban board styling */
        .kanban-board-container {
            overflow-x: auto;
            display: flex;
            justify-content: flex-start;
            margin: 0 20px;
        }

        .row.kanban-board,
        .kanban-row {
            flex-wrap: nowrap;
            display: flex;
            overflow-x: auto;
        }

        .col.kanban-column {
            flex: 0 0 auto;
            width: 415px;
            margin-right: 20px;
            border: 2px solid #0000002a;
            border-radius: 10px;
            background: #ffffff;
        }

        .kanban-drag-area {
            position: relative;
            z-index: 2;
            min-height: 300px;
        }

        .kanban-card {
            height: 300px;
            width: 380px;
            position: relative;
            margin: auto 0 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border: 2px solid #7b00ff;
            border-radius: 10px;
            cursor: move;
            color: #2300c0;
            box-shadow: 2px 2px 2px #0d00ff;
        }

        .kanban-column h3 {
            color: #ff005d;
            text-align: center;
        }

        .kanban-column-bg {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 0;
        }

        /* Leaderboard styling */
        .full-width,
        .leaderboard {
            width: 100%;
            overflow-x: auto;
        }

        .employer-logo {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }

        .company-name {
            color: rgb(4, 0, 255);
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }

        .logo-container,
        .action-buttons,
        .info-container {
            flex: 1;
        }

        .job-details,
        .action-area,
        .action-icons {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .job-details {
            flex-direction: column;
        }

        .action-icons,
        .action-area {
            justify-content: space-between;
            width: 100%;
        }

        .job-status {
            font-weight: bold;
            color: #0011ff;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .remove-icon,
        .logo-apply {
            font-size: 35px;
            cursor: pointer;
            margin: 0 10px;
        }

        .job-title {
            white-space: wrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            font-size: 20px;
        }

        #Saved-header::before,
        #Applied-header::before,
        #Interviewing-header::before,
        #Accepted-header::before,
        #Declined-header::before {
            font-size: 48px;
            display: block;
            text-align: center;
            margin-bottom: 5px;
        }

        #Saved-header::before {
            content: "\2665";
            /* Unicode for heart symbol */
        }

        #Applied-header::before {
            content: "\2713";
            /* Unicode for check mark */
        }

        #Interviewing-header::before {
            content: "\1F4AC";
            /* Unicode for speech bubble */
        }

        #Accepted-header::before {
            content: "\1F44D";
            /* Unicode for thumbs up */
        }

        #Declined-header::before {
            content: "\1F44E";
            /* Unicode for thumbs down */
        }

        /* Background colors for each Kanban column */
        #Saved .kanban-column-bg {
            background-color: #FFFFCC;
        }

        #Applied .kanban-column-bg {
            background-color: #CCFFFF;
        }

        #Interviewing .kanban-column-bg {
            background-color: #E6CCFF;
        }

        #Accepted .kanban-column-bg {
            background-color: #CCFFCC;
        }

        #Declined .kanban-column-bg {
            background-color: #FFCCCC;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="margin-right: 20px;">
        <a class="navbar-brand" href="https://www.mycareermax.com" style="color: #003c86;">myCareerMax.com</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard" style="color: #003c86;">myDashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/careerclick" style="color: #003c86;">AI Job Search</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tools" style="color: #003c86;">Createâœ¨</a>
                </li>
                <!-- Tools Dropdown -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false" style="color: #003c86;">
                        Tools
                    </a>
                    <div class="dropdown-menu" aria-labelledby="toolsDropdown">
                        <a class="dropdown-item" href="/resume-enhancer" style="color: #003c86;">Resume Scanner</a>
                        <a class="dropdown-item" href="/interview-prep" style="color: #003c86;">Interview Prep</a>
                    </div>
                </li>
                <!-- New link for CareerBot -->
                <li class="nav-item">
                    <a class="nav-link" href="/careerbot" style="color: #003c86;">Max</a>
                </li>
                <!-- Existing dropdown for the username -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: #003c86;">
                        <span id="username-placeholder">Login Here</span>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="/dashboard#my-docs" style="color: #003c86;">My AI Docs</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/login" style="color: #00b018;">Login</a>
                        <a class="dropdown-item" href="/logout" style="color: #0d00ff;">Logout</a>
                        <a class="dropdown-item" href="/delete_account" style="color: #ff0000;">Delete Account</a>
                    </div>
                </li>
                <!-- End of Dropdown for username -->
            </ul>
        </div>
    </nav>
    <!--ADDING LEADERBOARD -->
    <div id="leaderboard-container" class="w-100 full-width">
        <table class="leaderboard w-100">
            <!-- The leaderboard table will be inserted here -->
        </table>
    </div>

    <!-- Tracker -->
    <!-- Saved jobs will be dynamically added here -->
    </div>
    </div>
    <!-- Kanban style board added here -->
    <div class="container-fluid mt-5 mb-5">
        <h2 class="text-center"><strong>myJobs Tracker</strong></h2>
        <div class="kanban-board-container">
            <div class="row kanban-row">
                <div class="col kanban-column" id="Saved">
                    <div class="kanban-column-bg"></div> <!-- New line -->
                    <div class="kanban-column-header" id="Saved-header">
                        <h3>Saved</h3>
                    </div>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Applied">
                    <div class="kanban-column-bg"></div> <!-- New line -->
                    <div class="kanban-column-header" id="Applied-header">
                        <h3>Applied</h3>
                    </div>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Interviewing">
                    <div class="kanban-column-bg"></div> <!-- New line -->
                    <div class="kanban-column-header" id="Interviewing-header">
                        <h3>Interviewing</h3>
                    </div>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Accepted">
                    <div class="kanban-column-bg"></div> <!-- New line -->
                    <div class="kanban-column-header" id="Accepted-header">
                        <h3>Accepted</h3>
                    </div>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Declined">
                    <div class="kanban-column-bg"></div> <!-- New line -->
                    <div class="kanban-column-header" id="Declined-header">
                        <h3>Declined</h3>
                    </div>
                    <div class="kanban-drag-area"></div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // Function to force a DOM element to redraw
        function forceRedraw(element) {
            const disp = getComputedStyle(element).display;
            element.style.display = 'none';
            const trick = element.offsetHeight; // trigger a reflow by reading offsetHeight
            element.style.display = disp;
        }

        // Initialize Kanban Drag and Drop functionality
        function initializeKanbanDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                const dragArea = column.querySelector('.kanban-drag-area');

                dragArea.addEventListener('dragover', function (event) {
                    event.preventDefault();
                });

                dragArea.addEventListener('drop', function (event) {
                    event.preventDefault();
                    const draggedId = event.dataTransfer.getData('text');
                    const draggedElement = document.getElementById(draggedId);
                    this.appendChild(draggedElement);

                    // Update the job's status label
                    const newStatus = this.closest('.kanban-column').id;
                    const statusLabel = draggedElement.querySelector('.job-status');
                    if (statusLabel) {
                        statusLabel.textContent = newStatus;
                    }

                    // Update the job status on the server
                    fetch("/update-job-status", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ new_status: newStatus, job_id: draggedId.split('-')[1] })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log("Job status updated successfully!");
                            } else {
                                console.error("Failed to update job status:", data.error);
                            }
                        });
                });
            });
        }

        // Function to handle status click (this will show a dropdown)
        function handleStatusClick(event) {
            const jobId = event.target.closest('.kanban-card').id.split('-')[1];
            const currentStatus = event.target.textContent;
            const statusDropdown = document.createElement("select");
            const statuses = ['Saved', 'Applied', 'Interviewing', 'Accepted', 'Declined'];  // Replace with your actual statuses

            statuses.forEach(status => {
                const option = document.createElement("option");
                option.value = status;
                option.text = status;
                if (status === currentStatus) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });

            event.target.replaceWith(statusDropdown);
            statusDropdown.focus();

            statusDropdown.addEventListener("change", function () {
                const newStatus = this.value;

                fetch("/update-job-status", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ new_status: newStatus, job_id: jobId })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log("Job status updated successfully!");
                            location.reload();

                            // Replace dropdown with new status text
                            const newStatusLabel = document.createElement("span");
                            newStatusLabel.className = "job-status";
                            newStatusLabel.textContent = newStatus;
                            newStatusLabel.addEventListener("click", handleStatusClick);
                            this.replaceWith(newStatusLabel);

                        } else {
                            console.error("Failed to update job status:", data.error);
                        }
                    });
            });
        }
        // Existing JavaScript for fetching jobs and creating cards
        fetch("/get-saved-jobs")
            .then(response => {
                if (!response.ok) {
                    console.error(`Failed to fetch with status: ${response.status}`);
                    throw new Error(`Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);  // Log the received data for debugging
                if (data.success) {
                    console.log(`Creating cards for ${data.saved_jobs.length} saved jobs.`);
                    data.saved_jobs.forEach(job => {
                        console.log(`Processing job with id ${job.id}`);
                        const jobCard = document.createElement("div");
                        jobCard.className = "kanban-card";
                        jobCard.id = `job-${job.id}`;
                        jobCard.draggable = true;

                        const statusLabel = document.createElement("span");
                        statusLabel.className = "job-status";
                        statusLabel.textContent = job.status;
                        statusLabel.addEventListener("click", handleStatusClick);
                        jobCard.appendChild(statusLabel);

                        const employerLogo = document.createElement("img");
                        employerLogo.src = job.employer_logo;
                        employerLogo.className = "employer-logo";
                        employerLogo.onerror = function () {
                            this.style.display = 'none'; // Hide broken image
                        };
                        jobCard.appendChild(employerLogo);

                        const jobTitle = document.createElement("h4");
                        jobTitle.textContent = job.job_title;
                        jobTitle.className = "job-title";

                        jobTitle.addEventListener("click", () => {
                            if (jobTitle.style.whiteSpace === "normal") {
                                jobTitle.style.whiteSpace = "nowrap";
                                jobTitle.style.overflow = "hidden";
                                jobTitle.style.textOverflow = "ellipsis";
                            } else {
                                jobTitle.style.whiteSpace = "normal";
                                jobTitle.style.overflow = "visible";
                                jobTitle.style.textOverflow = "clip";
                            }
                        });

                        jobCard.appendChild(jobTitle);

                        const companyName = document.createElement("p");
                        companyName.textContent = job.company_name;
                        companyName.className = "company-name";
                        jobCard.appendChild(companyName);

                        const actionIcons = document.createElement("div");
                        actionIcons.className = "action-icons";

                        const jobLink = document.createElement("img");
                        jobLink.src = "/static/icon48.png";  // Point this to your static folder
                        jobLink.className = "logo-apply";
                        jobLink.alt = "Document";
                        jobLink.addEventListener("click", () => {
                            window.open(job.job_link, "_blank");
                        });
                        actionIcons.appendChild(jobLink);

                        // Add compatibility percentage span between jobLink and removeIcon
                        const compatibilityPercentage = document.createElement("span");
                        compatibilityPercentage.textContent = `${job.compatibility}%`;  // assuming the field name is 'compatibility' from the data
                        compatibilityPercentage.className = "compatibility-percentage";
                        actionIcons.appendChild(compatibilityPercentage);

                        const removeIcon = document.createElement("span");
                        removeIcon.innerHTML = "&#9940;";
                        removeIcon.className = "remove-icon";
                        removeIcon.addEventListener("click", () => {
                            removeSavedJob(job.id);
                        });
                        actionIcons.appendChild(removeIcon);

                        jobCard.appendChild(actionIcons);


                        jobCard.addEventListener("dragstart", function (event) {
                            event.dataTransfer.setData("text", event.target.id);
                        });

                        const appropriateColumnElement = document.getElementById(job.status);
                        if (appropriateColumnElement) {
                            const appropriateColumn = appropriateColumnElement.querySelector(".kanban-drag-area");
                            if (appropriateColumn) {
                                appropriateColumn.appendChild(jobCard);
                                forceRedraw(jobCard);  // If you have a forceRedraw function
                                console.log(`Added job card for job id ${job.id} to column ${job.status}`);
                            } else {
                                console.error(`.kanban-drag-area not found in column ${job.status}`);
                            }
                        } else {
                            console.error(`Column with id ${job.status} not found`);
                        }
                    });

                    console.log("Initializing kanban drag and drop functionality.");
                    initializeKanbanDragAndDrop();
                } else {
                    console.error("Failed to fetch saved jobs:", data.error);
                }
            })
            .catch(error => {
                console.error("Error occurred while fetching saved jobs:", error);
            });


        // Delete the saved job from myJobs Tracker and dbo.saved_jobs
        function removeSavedJob(jobId) {
            fetch("/remove-saved-job", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ job_id: jobId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const jobCard = document.getElementById(`job-${jobId}`);
                        jobCard.remove();
                        alert("Job removed successfully!");
                    } else {
                        console.error("Failed to remove saved job:", data.error);
                    }
                });
        }

        function fetchRankedJobs() {
            $.ajax({
                url: "/get-ranked-jobs",
                type: "GET",
                dataType: "json",
                success: function (response) {
                    if (response.success) {
                        let rankedJobs = response.ranked_jobs;
                        let leaderboardHtml = `<table class="leaderboard">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Score (%)</th>
                <th>Job Title</th>
                <th>Company Name</th>
                <th>Job Link</th>
            </tr>
        </thead>
        <tbody>`;

                        // Populate the leaderboard
                        rankedJobs.forEach((job, index) => {
                            let green = Math.floor((job.score / 100) * 255);
                            let red = Math.floor(255 - (job.score / 100) * 255);
                            let bgColor = `rgb(${red}, ${green}, 0)`;
                            leaderboardHtml += `<tr style="background-color:${bgColor};">
                <td>${index + 1}</td>
                <td>${job.score}</td>
                <td>${job.job_title}</td>
                <td>${job.company_name}</td>
                <td><a href="${job.job_link}" target="_blank" class="btn btn-primary">Apply</a></td>
            </tr>`;
                        });
                        leaderboardHtml += '</tbody></table>';
                        $("#leaderboard-container").html(leaderboardHtml);
                    } else {
                        console.error("Failed to fetch ranked jobs: ", response.error);
                    }
                },
                error: function (error) {
                    console.error("Error: ", error);
                }
            });
        }

        // Function to handle status change click
        function handleStatusClick(event) {
            const jobId = event.target.closest('.kanban-card').id.split('-')[1];
            const currentStatus = event.target.textContent;

            // Create dropdown
            const statusDropdown = document.createElement("select");
            const statuses = ['Saved', 'Applied', 'Interviewing', 'Accepted', 'Declined'];  // Replace with your actual statuses
            statuses.forEach(status => {
                const option = document.createElement("option");
                option.value = status;
                option.text = status;
                if (status === currentStatus) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });

            // Create "Save" button
            const saveButton = document.createElement("button");
            saveButton.textContent = "Save";
            saveButton.addEventListener("click", function () {
                const newStatus = statusDropdown.value;

                // Update the job status on the server
                fetch("/update-job-status", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ new_status: newStatus, job_id: jobId })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();  // Refresh the page
                        } else {
                            console.error("Failed to update job status:", data.error);
                        }
                    });
            });

            // Replace status text with dropdown and save button
            const wrapper = document.createElement("div");
            wrapper.appendChild(statusDropdown);
            wrapper.appendChild(saveButton);
            event.target.replaceWith(wrapper);
            statusDropdown.focus();
        }

        //       $(document).ready(function () {
        //         fetchRankedJobs();
        //   });

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>myJobs | myCareerMax</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Preconnect to font domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font and other styles -->

    <style>
        /* General styling */
        body {
            background: linear-gradient(to bottom, #B3B3B3, #808080);
            color: #ffffff;
            /* Make text white */
        }

        h2 {
            color: #ffffff;
            /* Make text white */
            font-size: 24px;
            /* Increase text size */
        }

        /* Kanban board styling */
        .kanban-board-container {
            overflow-x: auto;
            display: flex;
            justify-content: flex-start;
            /* Align items to the start */
            margin-left: 20px;
            /* Add left margin */
            margin-right: 20px;
            /* Add right margin */
        }

        .row.kanban-board {
            flex-wrap: nowrap;
            display: flex;
            min-width: min-content;
        }

        .col.kanban-column {
            flex: 0 0 auto;
            min-width: 400px;
            max-width: 400px;
            /* Set a maximum width */
            margin-right: 20px;
            border: 2px solid #00ff2a;
            border-radius: 10px;
            background: linear-gradient(to bottom, #a2cfff, #6f31ff);
        }

        .kanban-drag-area {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Horizontal centering */
        }

        .kanban-card {
            width: 275px;
            height: 275px;
            position: relative;
            margin: auto;
            /* Center the card */
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center items horizontally */
            justify-content: center;
            /* Center items vertically */
            background: linear-gradient(to bottom, #007bff, #ffffff);
            /* Gradient background */
            border: 2px solid #ccc;
            border-radius: 10px;
            cursor: move;
            margin-bottom: 20px;
            color: #ffffff;
            /* Set text color to white */
        }

        .remove-button {
            /* Modern looking bootstrap button */
            background-color: #007bff;
            border: none;
            color: white;
            padding: 12px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
        }

        .kanban-column h3 {
            color: #ffffff;
            /* Set text color to white */
            text-align: center;
            /* Center the text */
        }

        /* Leaderboard styling */
        .full-width {
            width: 100%;
            overflow-x: auto;
        }

        .leaderboard {
            width: 100%;
        }

        .employer-logo {
            width: 50px;
            height: 50px;
        }

        /* Make company_name text purple */
        .company-name {
            color: purple;
            font-weight: bold;
        }

        /* Increase the size of the document emoji */
        .document-emoji {
            font-size: 48px;
        }

        .remove-emoji {
            cursor: pointer;
            font-size: 40px;
        }

        .remove-emoji,
        .document-emoji {
            cursor: pointer;
        }

        .logo-container {
            flex: 1;
        }

        .job-details {
            flex: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .action-buttons {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .info-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .action-area {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .job-status {
            font-weight: bold;
            color: #FF9900;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="margin-right: 20px;">
        <a class="navbar-brand" href="https://www.mycareermax.com" style="color: #003c86;">myCareerMax.com</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard" style="color: #003c86;">myDashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/careerclick" style="color: #003c86;">AI Job Search</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tools" style="color: #003c86;">Createâœ¨</a>
                </li>
                <!-- Tools Dropdown -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false" style="color: #003c86;">
                        Tools
                    </a>
                    <div class="dropdown-menu" aria-labelledby="toolsDropdown">
                        <a class="dropdown-item" href="/resume-enhancer" style="color: #003c86;">Resume Scanner</a>
                        <a class="dropdown-item" href="/interview-prep" style="color: #003c86;">Interview Prep</a>
                    </div>
                </li>
                <!-- New link for CareerBot -->
                <li class="nav-item">
                    <a class="nav-link" href="/careerbot" style="color: #003c86;">Max</a>
                </li>
                <!-- Existing dropdown for the username -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: #003c86;">
                        <span id="username-placeholder">Login Here</span>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="/dashboard#my-docs" style="color: #003c86;">My AI Docs</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/login" style="color: #00b018;">Login</a>
                        <a class="dropdown-item" href="/logout" style="color: #0d00ff;">Logout</a>
                        <a class="dropdown-item" href="/delete_account" style="color: #ff0000;">Delete Account</a>
                    </div>
                </li>
                <!-- End of Dropdown for username -->
            </ul>
        </div>
    </nav>
    <!--ADDING LEADERBOARD -->
    <div id="leaderboard-container" class="w-100 full-width">
        <table class="leaderboard w-100">
            <!-- The leaderboard table will be inserted here -->
        </table>
    </div>

    <!-- Tracker -->
    <!-- Saved jobs will be dynamically added here -->
    </div>
    </div>
    <!-- Kanban style board added here -->
    <div class="container-fluid mt-5 mb-5">
        <h2 class="text-center"><strong>myJobs Tracker</strong></h2>
        <div class="kanban-board-container"> <!-- New wrapper div -->
            <div class="row kanban-board" id="kanban-board">
                <div class="col kanban-column" id="Saved">
                    <h3>Saved</h3>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Applied">
                    <h3>Applied</h3>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Interviewing">
                    <h3>Interviewing</h3>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Accepted">
                    <h3>Accepted</h3>
                    <div class="kanban-drag-area"></div>
                </div>
                <div class="col kanban-column" id="Declined">
                    <h3>Declined</h3>
                    <div class="kanban-drag-area"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            console.log("Fetching username...");
            $.get("/get-username", function (response) {
                console.log("Username response:", response);
                if (response.success) {
                    const usernamePlaceholder = document.getElementById("username-placeholder");
                    usernamePlaceholder.textContent = "Hello, " + response.username;
                } else {
                    console.error('Error fetching username:', response.error);
                }
            });
        });

        // Include your initializeKanbanDragAndDrop function here
        function initializeKanbanDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                const dragArea = column.querySelector('.kanban-drag-area');

                dragArea.addEventListener('dragover', function (event) {
                    event.preventDefault();
                });

                dragArea.addEventListener('drop', function (event) {
                    event.preventDefault();
                    const draggedId = event.dataTransfer.getData('text');
                    const draggedElement = document.getElementById(draggedId);
                    this.appendChild(draggedElement);

                    // Extract job id from element id (assuming it's of the form 'job-<id>')
                    const jobId = draggedId.split('-')[1];
                    const newStatus = this.closest('.kanban-column').id;  // Get the id of the closest kanban-column element

                    // Update the job status on the server
                    fetch("/update-job-status", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ new_status: newStatus, job_id: jobId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log("Job status updated successfully!");
                            } else {
                                console.error("Failed to update job status:", data.error);
                            }
                        });
                });
            });
        }

        // Existing JavaScript for fetching jobs and creating cards
        fetch("/get-saved-jobs")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.saved_jobs.forEach(job => {
                        const jobCard = document.createElement("div");
                        jobCard.className = "kanban-card";
                        jobCard.id = `job-${job.id}`;
                        jobCard.draggable = true;

                        const statusLabel = document.createElement("span");
                        statusLabel.className = "status-label";
                        statusLabel.textContent = job.status;
                        jobCard.appendChild(statusLabel);

                        const employerLogo = document.createElement("img");
                        employerLogo.src = job.employer_logo;
                        employerLogo.className = "employer-logo";
                        jobCard.appendChild(employerLogo);

                        const jobTitle = document.createElement("h4");
                        jobTitle.textContent = job.job_title;
                        jobCard.appendChild(jobTitle);

                        const companyName = document.createElement("p");
                        companyName.textContent = job.company_name;
                        companyName.className = "company-name";
                        jobCard.appendChild(companyName);

                        const actionIcons = document.createElement("div");
                        actionIcons.className = "action-icons";

                        const jobLink = document.createElement("a");
                        jobLink.href = job.job_link;
                        jobLink.target = "_blank";
                        jobLink.innerHTML = "&#128462;";
                        jobLink.className = "document-emoji";
                        actionIcons.appendChild(jobLink);

                        const removeIcon = document.createElement("span");
                        removeIcon.innerHTML = "&#9940;";
                        removeIcon.className = "remove-icon";
                        removeIcon.addEventListener("click", () => {
                            removeSavedJob(job.id);
                        });
                        actionIcons.appendChild(removeIcon);

                        jobCard.appendChild(actionIcons);

                        jobCard.addEventListener("dragstart", function (event) {
                            event.dataTransfer.setData("text", event.target.id);
                        });

                        // Touch events
                        jobCard.addEventListener('touchstart', handleTouchStart, false);
                        jobCard.addEventListener('touchmove', handleTouchMove, false);
                        jobCard.addEventListener('touchend', handleTouchEnd, false);

                        const appropriateColumn = document.getElementById(job.status).querySelector(".kanban-drag-area");
                        appropriateColumn.appendChild(jobCard);
                    });

                    initializeKanbanDragAndDrop();
                } else {
                    console.error("Failed to fetch saved jobs:", data.error);
                }
            });

        // Define the touch handlers
        let xDown = null;
        let yDown = null;

        function handleTouchStart(evt) {
            xDown = evt.touches[0].clientX;
            yDown = evt.touches[0].clientY;
        };

        let draggedEl;
        let targetEl;

        function handleTouchStart(evt) {
            xDown = evt.touches[0].clientX;
            yDown = evt.touches[0].clientY;
            draggedEl = evt.target.closest('.kanban-card');
        }

        function handleTouchMove(evt) {
            // You can implement touch-based dragging here
            if (!xDown || !yDown) {
                return;
            }

            let xUp = evt.touches[0].clientX;
            let yUp = evt.touches[0].clientY;

            // Calculate the distance moved
            let xDiff = xDown - xUp;
            let yDiff = yDown - yUp;

            // Determine swipe direction and move the dragged element
            if (Math.abs(xDiff) > Math.abs(yDiff)) {
                draggedEl.style.left = (draggedEl.offsetLeft - xDiff) + "px";
            } else {
                draggedEl.style.top = (draggedEl.offsetTop - yDiff) + "px";
            }

            xDown = xUp;
            yDown = yUp;

            // Detect target element
            targetEl = document.elementFromPoint(xUp, yUp).closest('.kanban-drag-area');
        }

        function handleTouchEnd(evt) {
            // You can implement releasing the dragged element here
            if (targetEl) {
                targetEl.appendChild(draggedEl);
            }
            draggedEl.style.left = "";
            draggedEl.style.top = "";
            xDown = null;
            yDown = null;
        }
        // Delete the saved job from myJobs Tracker and dbo.saved_jobs
        function removeSavedJob(jobId) {
            fetch("/remove-saved-job", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ job_id: jobId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const jobCard = document.getElementById(`job-${jobId}`);
                        jobCard.remove();
                        alert("Job removed successfully!");
                    } else {
                        console.error("Failed to remove saved job:", data.error);
                    }
                });
        }

        function fetchRankedJobs() {
            $.ajax({
                url: "/get-ranked-jobs",
                type: "GET",
                dataType: "json",
                success: function (response) {
                    if (response.success) {
                        let rankedJobs = response.ranked_jobs;
                        let leaderboardHtml = `<table class="leaderboard">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Score (%)</th>
                <th>Job Title</th>
                <th>Company Name</th>
                <th>Job Link</th>
            </tr>
        </thead>
        <tbody>`;

                        // Populate the leaderboard
                        rankedJobs.forEach((job, index) => {
                            let green = Math.floor((job.score / 100) * 255);
                            let red = Math.floor(255 - (job.score / 100) * 255);
                            let bgColor = `rgb(${red}, ${green}, 0)`;
                            leaderboardHtml += `<tr style="background-color:${bgColor};">
                <td>${index + 1}</td>
                <td>${job.score}</td>
                <td>${job.job_title}</td>
                <td>${job.company_name}</td>
                <td><a href="${job.job_link}" target="_blank" class="btn btn-primary">Apply</a></td>
            </tr>`;
                        });
                        leaderboardHtml += '</tbody></table>';
                        $("#leaderboard-container").html(leaderboardHtml);
                    } else {
                        console.error("Failed to fetch ranked jobs: ", response.error);
                    }
                },
                error: function (error) {
                    console.error("Error: ", error);
                }
            });
        }

        $(document).ready(function () {
            fetchRankedJobs();
        });

    </script>
</body>

</html>
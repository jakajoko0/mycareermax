<!DOCTYPE html>

<html lang="en">

<head>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Satisfy&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@500&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@500&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Ultra&amp;display=swap" rel="stylesheet" />
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>myDashboard | myCareerMax</title>'
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>'
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        .table-container {
            margin-bottom: 50px;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .satisfy-font {
            font-family: 'Satisfy', cursive;
            color: #ffffff;
            /* Set the text color to white */
        }


        .logo-container {
            text-align: center;
            margin-top: 20px;
        }

        .responsive-logo {
            max-width: 100%;
            /* Ensures the image doesn't stretch beyond its container */
            height: auto;
            /* Maintains the image's aspect ratio */
            display: inline-block;
            /* To make it work with the text-align of the parent */
        }

        /* New styles for green text */
        .green-text,
        .green-text .nav-link,
        .green-text .navbar-brand {
            color: #007BFF !important;
        }

        /* Added styles for horizontal scrolling */
        #saved-jobs-container {
            display: flex;
            /* make it a flex container */
            overflow-x: auto;
            /* enable horizontal scrolling */
            white-space: nowrap;
            /* prevent wrapping of cards */
        }

        .card {
            flex: 0 0 auto;
            /* prevent cards from growing or shrinking */
            max-width: 300px;
            /* Set a max width for job cards */





            margin-right: 10px;
            /* spacing between cards */
            white-space: normal;
            /* Make sure the content wraps within the card */
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-image: linear-gradient(120deg, #b700ff, #3776ff);
            background-size: cover;
            background-attachment: fixed;
        }

        /* Updated styles for leaderboard container */
        #leaderboard-container {
            width: 100%;
            overflow-x: auto;
            background-color: #ffffff;
            /* Making the background white */
            border-radius: 12px;
            /* Adding rounded corners */
            overflow: hidden;
            /* Ensuring the content respects the rounded corners */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        @media screen and (max-width: 600px) {

            th,
            td {
                font-size: 14px;
            }
        }

        .navbar {
            background-image: linear-gradient(120deg, #ffffff, #ffffff);
            background-size: cover;
            background-attachment: fixed;
        }

        .percentage {
            font-family: 'Ultra', serif;
            color: #24c700;
            font-size: 20px;
        }

        .percentage {
            position: absolute;
            top: 2px;
            right: 2px;
        }

        .job-title {
            font-family: 'Varela Round', sans-serif;
            font-size: x-large;
            color: blue;
            text-align: center;
            display: flex;
            align-items: center;
            /* Center vertically */
            justify-content: center;
            /* Center horizontally */
            width: 100%;
            /* Ensure it takes full width */
        }

        .company-name {
            font-family: 'Kanit', sans-serif;
            font-size: larger;
            /* changed from 'large' to 'smaller' */
            color: rgb(0, 0, 174);
            text-align: center;
            display: flex;
            align-items: center;
            /* Center vertically */
            justify-content: center;
            /* Center horizontally */
            width: 100%;
            /* Full width to capture overflow */
        }

        .status select {
            font-size: 18px;
            padding: 4px;
        }


        .status {
            margin-bottom: 10px;
            /* Add some space below the dropdown */
        }

        .status-row-header {
            font-size: 20px;
            font-family: 'Noto Sans', sans-serif;
            margin-bottom: 10px
        }

        .status-row-header {
            color: #ffffff;
            text-align: center;
        }

        .job-cards-row {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            /* Remove fixed height */
        }

        .job-card {
            flex: 0 0 auto;
            width: 400px;
            padding: 15px;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgb(0, 0, 0);
            cursor: pointer;
            position: relative;
            background: linear-gradient(to right, rgb(255, 255, 255), rgb(255, 255, 255));
            /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
        }


        .job-card {
            position: relative;
        }



        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            margin: 15% auto;
            padding: 20px;
            width: 50%;
            background-color: #fff;
            border-radius: 10px;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .employer-logo {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 35px;
            height: 35px;
        }

        .job-card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            /* Change to min-height */
        }

        .white-text {
            color: white;
        }
    </style>
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script defer>
    $(document).ready(function () {
        console.log("Fetching username...");
        $.get("/get-username", function (response) {
            console.log("Username response:", response);
            if (response.success) {
                const usernamePlaceholder = document.getElementById("username-placeholder");
                usernamePlaceholder.textContent = "Hello, " + response.username;
            } else {
                console.error('Error fetching username:', response.error);
            }
        });
    });
</script>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="margin-right: 20px;">
        <a class="navbar-brand" href="https://www.mycareermax.com" style="color: #003c86;">myCareerMax.com</a>
        <button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
            data-target="#navbarNav" data-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard" style="color: #003c86;">myDashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/careerclick" style="color: #003c86;">AI Job Search</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tools" style="color: #003c86;">Create✨</a>
                </li>
                <!-- Tools Dropdown -->
                <li class="nav-item dropdown">
                    <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                        data-toggle="dropdown" href="#" id="toolsDropdown" role="button" style="color: #003c86;">
                        Tools
                    </a>
                    <div aria-labelledby="toolsDropdown" class="dropdown-menu">
                        <a class="dropdown-item" href="/resume-enhancer" style="color: #003c86;">Resume Scanner</a>
                        <a class="dropdown-item" href="/interview-prep" style="color: #003c86;">Interview Prep</a>
                    </div>
                </li>
                <!-- New link for CareerBot -->
                <li class="nav-item">
                    <a class="nav-link" href="/careerbot" style="color: #003c86;">Max</a>
                </li>
                <!-- Existing dropdown for the username -->
                <li class="nav-item dropdown">
                    <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                        data-toggle="dropdown" href="#" id="navbarDropdown" role="button" style="color: #003c86;">
                        <span id="username-placeholder">Login Here</span>
                    </a>
                    <div aria-labelledby="navbarDropdown" class="dropdown-menu">
                        <a class="dropdown-item" href="/dashboard#my-docs" style="color: #003c86;">My AI Docs</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/login" style="color: #00b018;">Login</a>
                        <a class="dropdown-item" href="/logout" style="color: #0d00ff;">Logout</a>
                        <a class="dropdown-item" href="/delete_account" style="color: #ff0000;">Delete Account</a>
                    </div>
                </li>
                <!-- End of Dropdown for username -->
            </ul>
        </div>
    </nav>

    <div style="text-align:center;">
        <img alt="Your Logo" src="{{ url_for('static', filename='images/white-mycareermax.png') }}"
            style="max-width:100%;" />
    </div>
    <!-- My Resume Button to Trigger Modal -->
    <div class="text-center">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#resumeModal">
            📄 Manage My Resume
        </button>
        <div class="uploaded-resume-name" style="margin-top: 20px; margin-bottom: 40px;"></div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="resumeModal" tabindex="-1" role="dialog" aria-labelledby="resumeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resumeModalLabel">My Resume</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Save Resume -->
                    <div class="container text-black">
                        <form id="uploadButtonOrForm" action="/upload_dashresume" method="post"
                            enctype="multipart/form-data">
                            <input type="file" name="resume" accept=".docx" required>
                            <button type="submit" class="btn btn-success">💾 Save Resume</button>
                        </form>
                        <div class="uploaded-resume-name white-text" style="margin-top: 20px; margin-bottom: 40px;">
                        </div>
                        <button id="delete-resume-button" class="btn btn-danger">🗑️ Delete Resume</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Tooltip Info Modal -->
    <div class="modal fade" id="tooltipInfoModal" tabindex="-1" aria-labelledby="tooltipInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tooltipInfoModalLabel">Top Candidate Board</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h2>🌟 Introducing the App Tracker! 🌟</h2>
                    <p>App Tracker Intro Goes Here</p>

                    <h3>What It Does</h3>
                    <p>Describe what the App Tracker does here</p>

                    <h3>📊 How It Works</h3>
                    <ul>
                        <li>How it Works #1</li>
                        <li>How it Works #2</li>
                        <li>How it Works #3</li>
                    </ul>

                    <h3>📝 Get Started in Two Simple Steps</h3>
                    <ol>
                        <li>Step 1 Goes Here</li>
                        <li>Step 2 Goes Here</li>
                    </ol>
                    <p><i>Note: If you don't complete these steps, the compatibility score for each job will remain
                            blank. We
                            need both ingredients
                            to cook up your success recipe!</i></p>

                    <h3>🥇 Why Use the App Tracker?</h3>
                    <ul>
                        <li>Reason #1</li>
                        <li>Reason #2</li>
                        <li>Reason #3</li>
                    </ul>
                    <p>Ready to take your job search to the next level? Don't miss out on this chance to be the
                        top
                        candidate you're
                        meant to be! 🚀</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Handling resume upload via jQuery
            $("#uploadButtonOrForm").on("submit", function (e) {
                e.preventDefault();
                let formData = new FormData(this);
                $.ajax({
                    url: '/upload_dashresume',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $('.uploaded-resume-name').text('Saved Resume: ' + response.filename).addClass('white-text');
                        } else {
                            console.error('Error fetching resume name:', response.error);
                        }

                    }
                });
            });

            // Fetch the latest resume name
            $.get("/get_latest_resume_name", function (response) {
                if (response.success) {
                    $('.uploaded-resume-name').text('Current Resume: ' + response.filename).addClass('white-text');
                } else {
                    console.error('Error uploading resume:', response.error);
                }

            });

            // Handling resume deletion via jQuery
            $("#delete-resume-button").on("click", function () {
                $.ajax({
                    url: '/delete_resume',
                    type: 'POST',
                    success: function (response) {
                        if (response.success) {
                            $('.uploaded-resume-name').text('No saved resume.');
                        } else {
                            console.error('Error deleting resume:', response.error);
                        }
                    }
                });
            });

            // Fetch the user's documents and populate the list
            $.get("/get_user_documents", function (data) {
                data.forEach(function (doc) {
                    $("#saved-documents-list").append(`<li class="list-group-item"><a href="/download_document/${doc.id}?format=docx">${doc.document_name} - DOCX</a> | <a href="/download_document/${doc.id}?format=pdf">${doc.document_name} - PDF</a></li>`);
                });
            });
        });

    </script>

    <div class="table-container" style="background-color: white; padding: 20px; border-radius: 10px;">
        <h2 style="color: #007BFF;">My Docs</h2> <!-- Changed color here -->
        <div class="table-responsive" id="my-docs">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Apply Link</th>
                        <th>Document</th>
                        <th>Job Title</th>
                        <th>Company Name</th>
                        <th>Interview Prep</th>
                        <th>Download DOCX</th>
                        <th>Download PDF</th>
                        <th>Delete</th>
                        <th>Creation Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documents %}
                    <tr>
                        <td><a href="{{ doc.apply_link }}" target="_blank">Apply</a></td>
                        <td>{{ doc.document_type }}</td>
                        <td>{{ doc.job_title }}</td>
                        <td>{{ doc.company_name }}</td>
                        <td><a href="/interview-prep" target="_blank">IntervueME</a></td>
                        <!-- Added this new cell -->
                        <td><a href="{{ url_for('download_document', document_id=doc.id, format='docx') }}">Download
                                DOCX</a></td>
                        <td><a href="{{ url_for('download_document', document_id=doc.id, format='pdf') }}">Download
                                PDF</a>
                        </td>
                        <td><button class="btn btn-danger" onclick="deleteDocument({{ doc.id }})">Delete</button>
                        </td>
                        <td>{{ doc.creation_date }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>


    <script>
        function deleteDocument(documentId) {
            if (confirm("Are you sure you want to delete this document?")) {
                $.ajax({
                    url: '/delete_document/' + documentId,
                    type: 'DELETE',
                    success: function (response) {
                        if (response.success) {
                            alert('Document deleted successfully!');
                            location.reload(); // Reload the page to update the table
                        } else {
                            alert('Error deleting document. Please try again.');
                        }
                    }
                });
            }
        }
    </script>
</body>

{% for status, jobs in saved_jobs_by_status.items() %}
{% if jobs|length > 0 %} {# Check if there are jobs under this status #}
<div class="status-row-header" id="status-header-{{ status|lower }}">
    <h2>{{ status }}</h2>
</div>
<div class="job-cards-row">
    {% for job in jobs %}
    <!-- Debug: Print out the job variable -->
    <script>
        console.log("Current job in loop:", {{ job | tojson | safe}});
    </script>
    <div class="job-card" data-job='{{ job|tojson|safe }}' onclick="showModal(this)">
        <img src="{{ url_for('static', filename='images/default_logo.png') }}" alt="Default Logo" class="employer-logo">
        <div class="job-card-content">
            <div class="status">
                <select data-job-id="{{ job.id }}" onchange="updateStatus(this, event);"
                    onclick="stopPropagation(event);">
                    <option value="Saved" {% if job.status=='Saved' %}selected{% endif %}>Saved</option>
                    <option value="Applied" {% if job.status=='Applied' %}selected{% endif %}>Applied</option>
                    <option value="Interviewing" {% if job.status=='Interviewing' %}selected{% endif %}>
                        Interviewing
                    </option>
                    <option value="Offered" {% if job.status=='Offered' %}selected{% endif %}>Offered</option>
                    <option value="Rejected" {% if job.status=='Rejected' %}selected{% endif %}>Rejected
                    </option>
                    <option value="Delete" {% if job.status=='Delete' %}selected{% endif %}>Delete</option>
                </select>
            </div>
            <div class="job-title">{{ job.job_title }}</div>
            <div class="company-name">{{ job.company_name }}</div>
        </div>
        <div class="percentage">{{ job.percentage }}%</div>
    </div>


    {% endfor %}
</div>
{% endif %} {# Close the if block here #}
{% endfor %}
<script>
    var currentUserId = "{{ current_user.id }}";
</script>

<script>
    function stopPropagation(e) {
        e.stopPropagation();
    }
</script>
<script>
    console.log("Job cards loaded.");
</script>
<!-- Modal -->
<div id="jobModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modalData"></div>
    </div>
</div>
<script>
    console.log("Modal section loaded.");
</script>
<script>
    // Modified showModal function with debugging lines
    function showModal(element) {
        console.log("showModal function called.");

        const rawData = element.getAttribute('data-job').trim();
        console.log("Raw data-job attribute:", rawData);

        let jobData;
        try {
            jobData = JSON.parse(rawData);
        } catch (e) {
            console.error("Error parsing job data:", e);
            return;
        }

        console.log("Parsed job data:", jobData);

        let modal = document.getElementById("jobModal");
        let modalData = document.getElementById("modalData");

        let employerLogoHtml = jobData.employer_logo !== 'N/A'
            ? `<img src="${jobData.employer_logo}" alt="Employer Logo" width="100" height="100">`
            : 'N/A';

        modalData.innerHTML = `
                    <div>${jobData.percentage}%</div>
                    <div>${jobData.status}</div>
                    <div>${jobData.job_title}</div>
                    <div>${jobData.company_name}</div>
                    <div>${jobData.job_description}</div>
                    <div><a href="${jobData.job_link}">${jobData.job_link}</a></div>
                <!-- <div>Keywords Extracted From Your Resume: ${jobData.keywords_job}</div> -->
                    <div></div>
                    <div>Keywords Extracted From Job Description: ${jobData.keywords_resume}</div>
            `;
        modal.style.display = "block";
        console.log("Modal displayed.");
    }

    function closeModal() {
        console.log("closeModal function called.");
        let modal = document.getElementById("jobModal");
        modal.style.display = "none";
        console.log("Modal closed.");
    }
</script>
<script>
    console.log("All scripts loaded.");
</script>
<script>
    function updateStatus(selectElement, event) {
        // Stop propagation to prevent showModal
        event.stopPropagation();

        const jobId = selectElement.getAttribute('data-job-id');
        const newStatus = selectElement.value;
        const userId = currentUserId;  // Assuming currentUserId is globally available

        console.log(`Job ID: ${jobId}, New Status: ${newStatus}`);  // Debugging line

        if (newStatus === 'Delete') {
            console.log('Attempting to delete job');  // Debugging line

            if (window.confirm('Are you sure you want to delete this job?')) {
                fetch('/remove-saved-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: jobId,
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Job successfully deleted');  // Debugging line
                            selectElement.closest('.job-card').remove();
                        } else {
                            alert('Failed to delete job: ' + data.error);
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        } else {
            fetch('/update-job-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_status: newStatus,
                    job_id: jobId,
                    user_id: userId  // This is usually not needed if you can identify the user on the server
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to update job status: ' + data.error);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    }

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2305706078196748"
        crossorigin="anonymous"></script>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>myDashboard | myCareerMax</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .logo-container {
            text-align: center;
            margin-top: 20px;
        }

        .responsive-logo {
            max-width: 100%;
            /* Ensures the image doesn't stretch beyond its container */
            height: auto;
            /* Maintains the image's aspect ratio */
            display: inline-block;
            /* To make it work with the text-align of the parent */
        }

        /* New styles for green text */
        .green-text,
        .green-text .nav-link,
        .green-text .navbar-brand {
            color: #007BFF !important;
        }

        /* Added styles for horizontal scrolling */
        #saved-jobs-container {
            display: flex;
            /* make it a flex container */
            overflow-x: auto;
            /* enable horizontal scrolling */
            white-space: nowrap;
            /* prevent wrapping of cards */
        }

        .card {
            flex: 0 0 auto;
            /* prevent cards from growing or shrinking */
            max-width: 300px;
            /* Set a max width for job cards */
            margin-right: 10px;
            /* spacing between cards */
            white-space: normal;
            /* Make sure the content wraps within the card */
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-image: linear-gradient(120deg, #adadad, #007BFF);
            background-size: cover;
            background-attachment: fixed;
        }

        /* New styles for leaderboard container */
        #leaderboard-container {
            width: 100%;
            overflow-x: auto;
            background-color: #ffffff;
            /* Making the background white */
            border-radius: 12px;
            /* Adding rounded corners */
            overflow: hidden;
            /* Ensuring the content respects the rounded corners */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        @media screen and (max-width: 600px) {

            th,
            td {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <!-- Your existing body content here -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Your existing scripts -->

    <script defer>
        // Your existing JavaScript code

        $(document).ready(function () {
            console.log("Fetching username...");
            $.get("/get-username", function (response) {
                console.log("Username response:", response);
                if (response.success) {
                    const usernamePlaceholder = document.getElementById("username-placeholder");
                    usernamePlaceholder.textContent = "Hello, " + response.username;
                } else {
                    console.error('Error fetching username:', response.error);
                }
            });

            // Rest of your existing JavaScript code...
        });
    </script>

    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="https://www.mycareermax.com" style="color: #003c86;">myCareerMax.com</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/careerclick" style="color: #003c86;">AI Job Search</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cover-letter-generator" style="color: #003c86;">AI Cover Letter</a>
                    </li>
                    <!-- Dropdown Menu for AI Resume Tools -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="resumeDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: #003c86;">
                            AI Resume Tools
                        </a>
                        <div class="dropdown-menu" aria-labelledby="resumeDropdown">
                            <a class="dropdown-item" href="/resume-enhancer" style="color: #003c86;">Resume Scanner</a>
                            <a class="dropdown-item" href="/ai-builder" style="color: #003c86;">AI Resume
                                Builder</a>
                        </div>
                    </li>
                    <!-- End of Dropdown -->
                    <li class="nav-item">
                        <a class="nav-link" href="/interview-prep" style="color: #003c86;">Interview Prep</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard" style="color: #003c86;">myDashboard</a>
                    </li>
                    <!-- Existing dropdown for the username -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: #003c86;">
                            <span id="username-placeholder">Login Here</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="/dashboard#my-docs" style="color: #003c86;">My AI Docs</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="/login" style="color: #00b018;">Login</a>
                            <a class="dropdown-item" href="/logout" style="color: #ff0000;">Logout</a>
                        </div>
                    </li>
                    <!-- End of Dropdown for username -->
                </ul>
            </div>
        </nav>




        <div style="text-align:center;">
            <img src="{{ url_for('static', filename='images/white-mycareermax.png') }}" alt="Your Logo"
                style="max-width:100%;" />
        </div>
        <!-- Save Resume -->
        <div class="container mt-5 text-white">
            <form id="uploadButtonOrForm" action="/upload_dashresume" method="post" enctype="multipart/form-data">
                <input type="file" name="resume" accept=".docx" required>
                <button type="submit" class="btn btn-success">ðŸ’¾ Save Resume</button>
            </form>
            <div id="uploaded-resume-name" style="margin-top: 20px; margin-bottom: 40px;"></div>
        </div>
        <!-- Adding a title for the leaderboard -->
        <h2 style="text-align:center; color: #000; margin-top: 40px;">âœ¨Job Compatibility Ranking</h2>


        <div id="leaderboard-container">
            <!-- The leaderboard table will be inserted here -->
        </div>
        <!-- Main Content -->
        <div class="container mt-5 mb-5" style="color: white;">
            <h2>My Saved Jobs</h2>
            <div id="saved-jobs-container">
                <!-- Saved jobs will be dynamically added here -->
            </div>
        </div>

        <script>
            $(document).ready(function () {

                // Handling resume upload via jQuery
                $("#uploadButtonOrForm").on("submit", function () {
                    let formData = new FormData(this);

                    $.ajax({
                        url: '/upload_dashresume',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.success) {
                                // Display the uploaded resume name
                                $('#uploaded-resume-name').text('Saved Resume: ' + response.filename);
                            } else {
                                console.error('Error uploading resume:', response.error);
                            }
                        }
                    });

                    return false;  // To prevent the form from actually submitting and refreshing the page
                });

                // Fetch the latest uploaded resume name for the user
                $.get("/get_latest_resume_name", function (response) {
                    if (response.success) {
                        // Display the resume name
                        $('#uploaded-resume-name').text('Current Resume: ' + response.filename);
                    } else {
                        console.error('Error fetching resume name:', response.error);
                    }
                });

                // Fetch and display saved jobs
                fetch("/get-saved-jobs")
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const savedJobsContainer = document.getElementById("saved-jobs-container");
                            data.saved_jobs.forEach(job => {
                                const jobCard = document.createElement("div");
                                jobCard.className = "card mb-3";
                                jobCard.style.width = "300px";

                                const cardBody = document.createElement("div");
                                cardBody.className = "card-body";
                                cardBody.style.height = "250px";
                                cardBody.style.overflowY = "auto";

                                // Append the employer logo if it exists
                                if (job.employer_logo) {
                                    const logoImg = document.createElement('img');
                                    logoImg.src = job.employer_logo;
                                    logoImg.alt = job.company_name + ' logo';
                                    logoImg.style.width = '100px';
                                    cardBody.appendChild(logoImg);
                                }

                                const applyLink = document.createElement("a");
                                applyLink.href = job.job_link;
                                applyLink.target = "_blank";
                                applyLink.className = "btn btn-primary mr-2";
                                applyLink.textContent = "Apply Here";

                                const jobTitle = document.createElement("h5");
                                jobTitle.className = "card-title";
                                jobTitle.style.color = "blue";
                                jobTitle.textContent = job.job_title;

                                const companyName = document.createElement("h6");
                                companyName.className = "card-text";
                                companyName.style.color = "green";
                                companyName.textContent = job.company_name;

                                const jobDescription = document.createElement("p");
                                jobDescription.className = "card-text";
                                jobDescription.style.color = "blue";
                                jobDescription.textContent = job.job_description;

                                const removeButton = document.createElement("button");
                                removeButton.className = "btn btn-danger";
                                removeButton.textContent = "Remove";

                                removeButton.onclick = function () {
                                    const jobId = job.id;

                                    $.ajax({
                                        url: "/remove-saved-job",
                                        type: "POST",
                                        contentType: "application/json",
                                        data: JSON.stringify({ job_id: jobId }),
                                        success: function (response) {
                                            if (response.success) {
                                                console.log("Job removed successfully!");
                                                jobCard.remove();
                                            } else {
                                                console.error("Failed to remove job:", response.error);
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.error("Failed to remove job:", error);
                                        }
                                    });
                                };


                                // Append buttons to cardBody
                                cardBody.appendChild(jobTitle);
                                cardBody.appendChild(companyName);
                                cardBody.appendChild(applyLink);
                                cardBody.appendChild(removeButton);
                                cardBody.appendChild(jobDescription);
                                jobCard.appendChild(cardBody);

                                savedJobsContainer.appendChild(jobCard);
                            });
                        } else {
                            console.error("Failed to fetch saved jobs:", data.error);
                        }
                    });

            });
        </script>

        <script defer>
            // Ensure jQuery is loaded
            if (typeof $ !== 'undefined') {
                $(document).ready(function () {
                    // Fetch the user's documents and populate the list
                    $.get("/get_user_documents", function (data) {
                        data.forEach(function (doc) {
                            $("#saved-documents-list").append(`<li class="list-group-item"><a href="/download_document/${doc.id}?format=docx">${doc.document_name} - DOCX</a> | <a href="/download_document/${doc.id}?format=pdf">${doc.document_name} - PDF</a></li>`);
                        });
                    });
                });
            } else {
                console.error("jQuery is not loaded.");
            }
        </script>

        <!-- Saved Documents Section -->

        <div class="table-container" style="background-color: white; padding: 20px; border-radius: 10px;">
            <h2 style="color: #007BFF;">My Docs</h2> <!-- Changed color here -->
            <div id="my-docs" class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Apply Link</th>
                            <th>Document</th>
                            <th>Job Title</th>
                            <th>Company Name</th>
                            <th>Interview Prep</th> <!-- Added this new header -->
                            <th>Download DOCX</th>
                            <th>Download PDF</th>
                            <th>Delete</th>
                            <th>Creation Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documents %}
                        <tr>
                            <td><a href="{{ doc.apply_link }}" target="_blank">Apply</a></td>
                            <td>{{ doc.document_type }}</td>
                            <td>{{ doc.job_title }}</td>
                            <td>{{ doc.company_name }}</td>
                            <td><a href="/interview-prep" target="_blank">IntervueME</a></td>
                            <!-- Added this new cell -->
                            <td><a href="{{ url_for('download_document', document_id=doc.id, format='docx') }}">Download
                                    DOCX</a></td>
                            <td><a href="{{ url_for('download_document', document_id=doc.id, format='pdf') }}">Download
                                    PDF</a>
                            </td>
                            <td><button onclick="deleteDocument({{ doc.id }})" class="btn btn-danger">Delete</button>
                            </td>
                            <td>{{ doc.creation_date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <script>
            function deleteDocument(documentId) {
                if (confirm("Are you sure you want to delete this document?")) {
                    $.ajax({
                        url: '/delete_document/' + documentId,
                        type: 'DELETE',
                        success: function (response) {
                            if (response.success) {
                                alert('Document deleted successfully!');
                                location.reload(); // Reload the page to update the table
                            } else {
                                alert('Error deleting document. Please try again.');
                            }
                        }
                    });
                }
            }

            // Function to fetch ranked jobs and populate the leaderboard
            function fetchRankedJobs() {
                $.ajax({
                    url: "/get-ranked-jobs",
                    type: "GET",
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {
                            let rankedJobs = response.ranked_jobs;
                            let leaderboardHtml = '<table class="leaderboard"><thead><tr><th>Rank</th><th>Score</th><th>Job Title</th><th>Company Name</th><th>Job Link</th></tr></thead><tbody>';

                            // Populate the leaderboard
                            rankedJobs.forEach((job, index) => {
                                let green = Math.floor((job.score / 100) * 255);
                                let red = Math.floor(255 - (job.score / 100) * 255);
                                let bgColor = `rgb(${red}, ${green}, 0)`;

                                leaderboardHtml += `<tr style="background-color:${bgColor};"><td>${index + 1}</td><td>${job.score}</td><td>${job.job_title}</td><td>${job.company_name}</td><td><a href="${job.job_link}" target="_blank" class="btn btn-primary">Apply</a></td></tr>`;
                            });

                            leaderboardHtml += '</tbody></table>';

                            // Insert the leaderboard into the DOM
                            $("#leaderboard-container").html(leaderboardHtml);
                        } else {
                            console.error("Failed to fetch ranked jobs: ", response.error);
                        }
                    },
                    error: function (error) {
                        console.error("Error: ", error);
                    }
                });
            }

            // Call the function when the dashboard page loads
            $(document).ready(function () {
                fetchRankedJobs();
            });





        </script>

        <!-- Add these script tags right before the closing </body> tag -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    </body>

</html>
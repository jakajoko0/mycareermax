<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myCareerMax Job Search</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }

        label,
        input,
        button {
            margin-bottom: 5px;
        }

        #jobs-list {
            width: 100%;
            /* background-color: #7300ff;
            /* Change this to the color you want for the container */
            height: calc(100vh - 150px);
            overflow-y: auto;
            padding: 20px;
            /* This adds padding inside the container around the job boxes */
        }

        .job h2 {
            margin-top: 0;
        }

        .job a {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
            margin-top: 10px;
        }

        .job-title {
            padding: 15px 10px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
        }

        .job-title:hover {
            background-color: #f5f5f5;
        }

        #search-container {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            background-image: radial-gradient(circle, #b700ff, #3776ff);
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 10px;
            /*  border-bottom: 1px solid #ccc; */
        }

        #search-container input[type="text"] {
            margin: 0 10px 10px 0;
            border-radius: 15px;
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
        }

        #search-container input[type="text"]::placeholder {
            text-align: center;
            font-size: 12px;
        }

        #search-button {
            padding: 3px 20px;
            font-size: 14px;
            border-radius: 15px;
            margin-left: 5px;
        }

        #main-content {
            padding-top: 150px;
            width: 100%;
            background-image: radial-gradient(circle, #b700ff, #3776ff);
            /*  background-image: linear-gradient(120deg, #b700ff, #3776ff); */
            /* Change this to your desired background color */
            display: flex;
            justify-content: center;
            /* This will center the child elements */
        }

        @media screen and (min-width: 768px) {
            #main-content {
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
                padding-top: 150px;
            }

            #jobs-list {
                width: 40%;
                border-right: 1px solid #ccc;
                height: calc(100vh - 150px);
                overflow-y: auto;
            }

            #selected-job-details {
                width: 60%;
                border: 1px solid #ccc;
                margin-bottom: 20px;
                margin-top: 20px;
                margin-left: 20px;
                margin-right: 20px;
                border-radius: 5px;
                background-color: white;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                height: calc(100vh - 150px);
                /* Match height of job listings */
                overflow-y: auto;
                /* Scrollbar appears if content overflows */
                padding: 20px;
            }

            .close-button {
                display: block;
            }
        }

        @media screen and (max-width: 767px) {
            #search-container {
                top: 56px;
            }

            #jobs-list {
                height: calc(100vh - 56px);
                overflow-y: auto;
            }

            #selected-job-details {
                display: none;
                position: fixed;
                top: 56px;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                z-index: 100;
                background-color: rgba(255, 255, 255, 0.9);
                max-height: calc(100vh - 150px);
                overflow-y: auto;
                padding: 20px;
                max-height: calc(100vh - 56px);
            }
        }

        .close-button {
            display: block;
            position: fixed;
            top: 65px;
            right: 15px;
            background: transparent;
            color: red;
            cursor: pointer;
            z-index: 101;
        }


        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
        }

        .job {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            /* This adds space between job boxes */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: white;
            /* This sets the job box background color */
            cursor: pointer;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .job-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .job-header-bottom {
            flex-basis: 100%;
            margin-top: 10px;
        }

        .logo-container {
            display: flex;
            justify-content: start;
            align-items: center;
        }

        .posted-at {
            margin-left: auto;
            padding: 5px;
            border-radius: 5px;
            background-color: #f8f8f8;
            font-size: 0.8em;
        }

        .employer-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .job-title {
            width: 100%;
            text-align: left;
            font-size: 1.25em;
            font-weight: bold;
            margin: 0;
            padding: 0;
        }

        .sub-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-size: 0.875em;
        }

        .employer-and-city-container {
            display: flex;
            align-items: center;
        }

        .employer-name,
        .job-city {
            margin-right: 5px;
        }

        .salary-remote-type-info {
            display: flex;
            justify-content: start;
            align-items: center;
            margin-top: 10px;
        }

        .salary-range,
        .job-type-remote,
        .employment-type {
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 10px;
            margin-right: 10px;
            background-color: #f8f8f8;
            display: inline-block;
        }

        .job.selected {
            border: 5px solid #66ff00;
        }
    </style>

</head>

<body>
    <input type="hidden" id="userId" value="{{ user_id }}">

    <script>
        $(document).ready(function () {
            console.log("Fetching username...");
            $.get("/get-username", function (response) {
                console.log("Username response:", response);
                if (response.success) {
                    const usernamePlaceholder = document.getElementById("username-placeholder");
                    usernamePlaceholder.textContent = "Hello, " + response.username;
                } else {
                    console.error('Error fetching username:', response.error);
                }
            });
        });
    </script>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="https://www.mycareermax.com" style="color: #003c86;">myCareerMax.com</a>
        <button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
            data-target="#navbarNav" data-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <!-- Existing dropdown for the username -->
                <li class="nav-item dropdown">
                    <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                        data-toggle="dropdown" href="#" id="navbarDropdown" role="button" style="color: #003c86;">
                        <span id="username-placeholder">Login Here</span>
                    </a>
                    <div aria-labelledby="navbarDropdown" class="dropdown-menu">
                        <a class="dropdown-item" href="/dashboard#my-docs" style="color: #003c86;">My AI Docs</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/login" style="color: #00b018;">Login</a>
                        <a class="dropdown-item" href="/logout" style="color: #0d00ff;">Logout</a>
                        <a class="dropdown-item" href="/delete_account" style="color: #ff0000;">Delete Account</a>
                    </div>
                </li>
                <!-- End of Dropdown for username -->
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard" style="color: #003c86;">myDashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/careerclick" style="color: #003c86;">AI Job Search</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/tools" style="color: #003c86;">Create✨</a>
                </li>
                <!-- Tools Dropdown -->
                <li class="nav-item dropdown">
                    <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle"
                        data-toggle="dropdown" href="#" id="toolsDropdown" role="button" style="color: #003c86;">
                        Tools
                    </a>
                    <div aria-labelledby="toolsDropdown" class="dropdown-menu">
                        <a class="dropdown-item" href="/resume-enhancer" style="color: #003c86;">Resume Scanner</a>
                        <a class="dropdown-item" href="/interview-prep" style="color: #003c86;">Interview Prep</a>
                    </div>
                </li>
                <!-- New link for CareerBot -->
                <li class="nav-item">
                    <a class="nav-link" href="/careerbot" style="color: #003c86;">Max</a>
                </li>
            </ul>
        </div>
    </nav>
    <div id="search-container">
        <label for="job-query"></label>
        <input type="text" id="job-query" placeholder="Enter job title or Keyword(s)">
        <label for="job-location"></label>
        <input type="text" id="job-location" placeholder="Enter location">
        <button id="search-button">Search</button>
    </div>

    <div id="main-content">
        <div id="jobs-list">
            <!-- Job listings will be dynamically inserted here -->
        </div>
        <div id="selected-job-details">
            <!-- Job details will be dynamically inserted here including the close button -->
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchButton = document.getElementById('search-button');
            const jobsList = document.getElementById('jobs-list');
            const selectedJobDetails = document.getElementById('selected-job-details');
            let page = 1; // Initialize page counter
            let isFetchingJobs = false;

            function toggleCloseButton(show) {
                const closeButton = document.querySelector('.close-button');
                if (window.innerWidth < 768) {
                    if (show) {
                        if (closeButton) closeButton.style.display = 'block';
                        jobsList.style.display = 'none';
                        document.getElementById('search-container').style.display = 'none';
                    } else {
                        if (closeButton) closeButton.style.display = 'none';
                        jobsList.style.display = 'block';
                        document.getElementById('search-container').style.display = 'flex';
                    }
                }
            }

            function bindCloseButton() {
                const closeButton = document.querySelector('.close-button');
                if (closeButton) {
                    closeButton.addEventListener('click', function () {
                        selectedJobDetails.style.display = 'none';
                        toggleCloseButton(false);
                    });
                }
            }

            function checkScreenSize() {
                if (window.innerWidth < 768) {
                    if (selectedJobDetails.style.display === 'none' || selectedJobDetails.style.display === '') {
                        document.getElementById('search-container').style.display = 'flex';
                        jobsList.style.display = 'block';
                    }
                } else {
                    document.getElementById('search-container').style.display = 'flex';
                    jobsList.style.display = 'block';
                }
                toggleCloseButton(selectedJobDetails.style.display === 'block');
            }

            function fetchMoreJobListings() {
                if (isFetchingJobs) return;
                isFetchingJobs = true;
                page++;

                fetch(`/fetch-job-listings?page=${page}`, {
                    method: 'GET',
                })
                    .then(response => response.json())
                    .then(data => {
                        displayJobListings(data.data || [], true);
                        isFetchingJobs = false;
                    })
                    .catch(error => {
                        console.error('Error fetching job listings:', error);
                        isFetchingJobs = false;
                    });
            }


            function resetAndFetchJobListings() {
                page = 1; // Reset the page counter
                jobsList.innerHTML = ''; // Clear the job list
                fetchJobListings(); // Fetch the job listings
            }

            if (searchButton) {
                searchButton.addEventListener('click', resetAndFetchJobListings);
            }

            function fetchJobListings() {
                console.log('Fetching job listings');
                const jobQuery = document.getElementById('job-query').value;
                const jobLocation = document.getElementById('job-location').value;
                // Do not reset page here anymore
                const queryParams = new URLSearchParams({
                    query: jobQuery,
                    location: jobLocation,
                    page: page
                });

                fetch(`/fetch-job-listings?${queryParams.toString()}`, {
                    method: 'GET'
                })
                    .then(response => response.json())
                    .then(data => {
                        displayJobListings(data.data || [], false);
                        isFetchingJobs = false;
                    })
                    .catch(error => {
                        console.error('Error fetching job listings:', error);
                        isFetchingJobs = false;
                    });
            }


            // Call this function once to setup the infinite scrolling
            function setupInfiniteScroll() {
                const jobsList = document.getElementById('jobs-list');
                jobsList.addEventListener('scroll', () => {
                    // Add a buffer amount to the condition to handle fast scrolling
                    if (jobsList.scrollTop + jobsList.clientHeight >= jobsList.scrollHeight - 200) {
                        fetchMoreJobListings();
                    }
                });
            }

            // Call this function once to setup the infinite scrolling
            setupInfiniteScroll();

            // Function to format job type
            function formatJobType(jobType) {
                const jobTypeMap = {
                    'FULLTIME': 'Full-time',
                    'INTERN': 'Intern',
                    'PERDIEM': 'Per diem',
                    'CONTRACTOR': 'Contractor',
                    'PARTTIME': 'Part-time',
                    'TEMPORARY': 'Temp'
                };
                // Return the mapped value or the original if not found in the map
                return jobTypeMap[jobType] || jobType;
            }

            // Function to format the date and time
            function formatDateTime(dateTimeString) {
                // Create a Date object from the dateTimeString
                const date = new Date(dateTimeString);
                // Format the date and time in a readable format
                return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            }

            // Function to remove 'selected' class from all job cards
            function clearSelectedJobCards() {
                document.querySelectorAll('.job.selected').forEach(function (jobCard) {
                    jobCard.classList.remove('selected');
                });
            }

            function displayJobListings(jobs, append = false) {
                let oldScrollPosition = jobsList.scrollTop;
                if (!append) {
                    jobsList.innerHTML = '';
                    selectedJobDetails.innerHTML = '';
                }


                jobs.forEach(job => {
                    // Create a new div for the job card
                    const jobCard = document.createElement('div');
                    jobCard.className = 'job';

                    // Create a container div for the logo and the date
                    const jobHeaderTop = document.createElement('div');
                    jobHeaderTop.className = 'job-header-top';

                    // Logo container
                    const logoContainer = document.createElement('div');
                    logoContainer.className = 'logo-container';
                    const logoImg = document.createElement('img');
                    logoImg.src = job.employer_logo || '/static/images/default_logo.png';
                    logoImg.alt = job.employer_name + ' logo';
                    logoImg.className = 'employer-logo';
                    logoImg.onerror = function () {
                        this.src = '/static/images/default_logo.png';
                    };
                    logoContainer.appendChild(logoImg);

                    // Append the logo container to the job header top
                    jobHeaderTop.appendChild(logoContainer);

                    // Date container
                    const postedAtDiv = document.createElement('div');
                    postedAtDiv.className = 'posted-at';
                    postedAtDiv.innerText = formatDateTime(job.job_posted_at_datetime_utc); // Use the correct field for the job posted date

                    // Append the date next to the logo container, not inside it
                    jobHeaderTop.appendChild(postedAtDiv);

                    // Create a new div for the job title, which will be below the logo and date
                    const jobHeaderBottom = document.createElement('div');
                    jobHeaderBottom.className = 'job-header-bottom';

                    // Job title
                    const jobTitle = document.createElement('div');
                    jobTitle.className = 'job-title';
                    jobTitle.innerText = job.job_title || 'No title provided';
                    jobHeaderBottom.appendChild(jobTitle);

                    // Append the job header top and bottom to the job card
                    jobCard.appendChild(jobHeaderTop);
                    jobCard.appendChild(jobHeaderBottom);

                    // Create a sub-container for employer name and job city
                    const subHeader = document.createElement('div');
                    subHeader.className = 'sub-header';

                    // Create a div for the employer name and add it to the sub-header
                    const employerNameDiv = document.createElement('div');
                    employerNameDiv.className = 'employer-name';
                    employerNameDiv.innerText = job.employer_name;
                    subHeader.appendChild(employerNameDiv);

                    // Add the job city if it is specified and not "Not specified"
                    if (job.job_city && job.job_city !== "Not specified") {
                        employerNameDiv.innerText += ', ' + job.job_city; // Append city to employer name
                    }

                    // Create a div for the employment type but do not append yet
                    const employmentTypeDiv = document.createElement('div');
                    employmentTypeDiv.className = 'employment-type';
                    employmentTypeDiv.innerText = formatJobType(job.job_employment_type) || 'Not specified';

                    // Append the sub-header to the job card
                    jobCard.appendChild(subHeader);

                    // Create a container for the salary, remote information, and employment type
                    const salaryRemoteTypeContainer = document.createElement('div');
                    salaryRemoteTypeContainer.className = 'salary-remote-type-info';

                    // Function to format salary
                    function formatSalary(salary) {
                        if (salary >= 1000) {
                            return `$${(salary / 1000).toFixed(0)}K`;
                        } else {
                            return `$${salary}`;
                        }
                    }

                    // Add salary information if available
                    if (job.job_max_salary && job.job_min_salary) {
                        const salaryRange = document.createElement('div');
                        salaryRange.className = 'salary-range';
                        salaryRange.innerText = `${formatSalary(job.job_min_salary)} - ${formatSalary(job.job_max_salary)}`;
                        salaryRemoteTypeContainer.appendChild(salaryRange);
                    }

                    // Add remote information
                    const jobTypeRemote = document.createElement('div');
                    jobTypeRemote.className = 'job-type-remote';
                    jobTypeRemote.innerText = job.job_is_remote ? 'Work From Home' : 'In-Person';
                    salaryRemoteTypeContainer.appendChild(jobTypeRemote);

                    // Append the employment type to the right
                    salaryRemoteTypeContainer.appendChild(employmentTypeDiv);

                    // Append the salary, remote, and type container to the job card
                    jobCard.appendChild(salaryRemoteTypeContainer);

                    // Event listener for when a job title is clicked
                    jobTitle.addEventListener('click', function () {
                        clearSelectedJobCards();
                        jobCard.classList.add('selected'); // Highlight the selected job card

                        // Populate the selectedJobDetails with detailed information
                        selectedJobDetails.innerHTML = `
            <span class="material-symbols-outlined close-button">close</span>
            <div class="job-details">
                <h2>${job.job_title}</h2>
                <p><strong>Employer:</strong> ${job.employer_name}</p>
                <p><strong>Employment Type:</strong> ${formatJobType(job.job_employment_type) || 'Not specified'}</p>
                <p><strong>Location:</strong> ${job.job_city || 'Not specified'}</p>
                <p><strong>Description:</strong> ${job.job_description}</p>
                <p><strong>Apply Link:</strong> ${job.job_apply_link ? `<a href="${job.job_apply_link}" target="_blank">Apply Here</a>` : 'Not provided'}</p>
                <div class="job-highlights">
                    <h3>Highlights</h3>
                    ${Object.entries(job.job_highlights).map(([key, value]) => `
                        <strong>${key}:</strong>
                        <ul>${value.map(item => `<li>${item}</li>`).join('')}</ul>
                    `).join('')}
                </div>
            </div>
        `;
                        selectedJobDetails.style.display = 'block';
                        toggleCloseButton(true);
                        bindCloseButton();
                    });


                    // Append the job card to the jobsList container
                    jobsList.appendChild(jobCard);
                });
                if (append) {
                    // Use setTimeout to delay the scroll restoration
                    setTimeout(() => {
                        jobsList.scrollTop = oldScrollPosition;
                    }, 0); // A timeout of 0 ms still pushes the execution to the end of the call stack
                }
            }
            setupInfiniteScroll();

            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);

        });
    </script>


</body>

</html>